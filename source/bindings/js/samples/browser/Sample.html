<!DOCTYPE html>
<html>
<head>
    <title>Speech Sample</title>
    <meta charset="utf-8" />
</head>
<body style="font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:13px;">
    <div id="warning">
        <h1 style="font-weight:500;">Speech Recognition SpeechSDK not found.</h1>
        <h2 style="font-weight:500;">Please execute <code>npm run bundle</code> and reload.</h2>
    </div>
    <div id="content" style="display:none">
        <table width="100%">
            <tr>
                <td></td>
                <td>
                    <h1 style="font-weight:500;">Speech Recognition</h1>
                    <h2 style="font-weight:500;">Microsoft Cognitive Services</h2>
                </td>
            </tr>
            <tr>
                <td align="right"><a href="https://www.microsoft.com/cognitive-services/en-us/sign-up" target="_blank">Subscription</a>:</td>
                <td><input id="key" type="text" size="40" value="YOUR_SPEECH_API_KEY"><b>YOUR_SPEECH_API_KEY</b></td>
            </tr>
            <tr>
                <td align="right">Language:</td>
                <td align="left">
                    <select id="languageOptions">
                        <option value="ar-EG">Arabic - EG</option>
                        <option value="ca-ES">Catalan - ES</option>
                        <option value="da-DK">Danish - DK</option>
                        <option value="da-DK">Danish - DK</option>
                        <option value="de-DE">German - DE</option>
                        <option value="en-AU">English - AU</option>
                        <option value="en-CA">English - CA</option>
                        <option value="en-GB">English - GB</option>
                        <option value="en-IN">English - IN</option>
                        <option value="en-NZ">English - NZ</option>
                        <option value="en-US" selected="selected">English - US</option>
                        <option value="es-ES">Spanish - ES</option>
                        <option value="es-MX">Spanish - MX</option>
                        <option value="fi-FI">Finnish - FI</option>
                        <option value="fr-CA">French - CA</option>
                        <option value="fr-FR">French - FR</option>
                        <option value="hi-IN">Hindi - IN</option>
                        <option value="it-IT">Italian - IT</option>
                        <option value="ja-JP">Japanese - JP</option>
                        <option value="ko-KR">Korean - KR</option>
                        <option value="nb-NO">Norwegian - NO</option>
                        <option value="nl-NL">Dutch - NL</option>
                        <option value="pl-PL">Polish - PL</option>
                        <option value="pt-BR">Portuguese - BR</option>
                        <option value="pt-PT">Portuguese - PT</option>
                        <option value="ru-RU">Russian - RU</option>
                        <option value="sv-SE">Swedish - SE</option>
                        <option value="zh-CN">Chinese - CN</option>
                        <option value="zh-HK">Chinese - HK</option>
                        <option value="zh-TW">Chinese - TW</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td align="right">Region:</td>
                <td align="left">
                    <select id="regionOptions">
                        <option value="westus2">West US2</option>
                        <option value="westus" selected="selected">West - US</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td align="right">Format:</td>
                <td align="left">
                    <select id="formatOptions">
                        <option value="Simple" selected="selected">Simple Result</option>
                        <option value="Detailed">Detailed Result</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td align="right">Input:</td>
                <td align="left">
                    <select id="inputSource">
                        <option value="Mic" selected="selected">Microphone</option>
                        <option value="File">Audio File</option>
                    </select>
                </td>
            </tr>
            <tr>
            <td></td>
            <td>
                <input type="file" id="filePicker" accept=".wav" style="display:none"/>
            </td>
            </tr>
            <tr>
                <td align="right"><b>Speech SpeechSDK API recognizeOnceAsync:</b></td>
                <td>
                    <button id="speechsdkStartRecognizeOnceAsync">recognizeOnceAsync()</button>
                    <button id="speechsdkStopRecognizeOnceAsync" disabled="disabled">STOP recognizeOnceAsync()</button>
                </td>
            </tr>
            <tr>
                <td align="right"><b>Speech SpeechSDK API Continous Recognition:</b></td>
                <td>
                    <button id="speechsdkStartContinousRecognition">startContinuousRecognitionAsync()</button>
                    <button id="speechsdkStopContinousRecognition" disabled="disabled">STOP stopContinuousRecognitionAsync()</button>
                </td>
            </tr>
            <tr>
                <td align="right"><b>Speech SpeechSDK API Translation:</b></td>
                <td>
                    <button id="speechsdkStartContinousTranslation">startContinousTranslation()</button>
                    <button id="speechsdkStopContinousTranslation" disabled="disabled">STOP stopContinousTranslation()</button>
                    <select id="languageTargetOptions">
                        <option value="ar-EG:Hoda">Arabic - EG</option>
                        <option value="ca-ES:Herena">Catalan - ES</option>
                        <option value="da-DK:Helle">Danish - DK</option>
                        <option value="de-DE-Hedda" selected="selected">German - DE</option>
                        <option value="en-AU:Catherine">English - AU</option>
                        <option value="en-CA:Linda">English - CA</option>
                        <option value="en-GB:Susan">English - GB</option>
                        <option value="en-IN:Heera">English - IN</option>
                        <option value="en-US:Zira">English - US</option>
                        <option value="es-ES:Laura">Spanish - ES</option>
                        <option value="es-MX:Sabina">Spanish - MX</option>
                        <option value="fi-FI:Heidi">Finnish - FI</option>
                        <option value="fr-CA:Caroline">French - CA</option>
                        <option value="fr-FR:Julie">French - FR</option>
                        <option value="hi-IN:Hemant">Hindi - IN</option>
                        <option value="it-IT:Elsa">Italian - IT</option>
                        <option value="ja-JP:Ayumi">Japanese - JP</option>
                        <option value="ko-KR:Minjoon">Korean - KR</option>
                        <option value="nb-NO:Jon">Norwegian - NO</option>
                        <option value="nl-NL:Marijke">Dutch - NL</option>
                        <option value="pl-PL:Paulina">Polish - PL</option>
                        <option value="pt-BR:Maria">Portuguese - BR</option>
                        <option value="pt-PT:Helia">Portuguese - PT</option>
                        <option value="ru-RU:Irina">Russian - RU</option>
                        <option value="sv-SE:Karin">Swedish - SE</option>
                        <option value="zh-CN:Kangkang">Chinese - CN</option>
                        <option value="zh-HK:Tracy">Chinese - HK</option>
                        <option value="zh-TW:Yating">Chinese - TW</option>
                    </select>
                    <input id="voiceOutput" type="checkbox" checked>
                    <label for="voiceOutput">voice output</label>
                    </td>
            </tr>
            <tr>
                <td></td>
                <td>
                    <table>
                        <tr>
                            <td>Results:</td>
                            <td>Current hypothesis:</td>
                        </tr>
                        <tr>
                            <td>
                                <textarea id="phraseDiv" style="display: inline-block;width:500px;height:200px"></textarea>
                            </td>
                            <td style="vertical-align: top">
                                <span id="hypothesisDiv" style="width:200px;height:200px;display:block;"></span>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
                <td align="right">Status:</td>
                <td align="left"><span id="statusDiv"></span></td>
            </tr>
        </table>
    </div>

    <!-- SpeechSDK REFERENCE -->
    <script src="../../distrib/microsoft.cognitiveservices.speech.sdk.bundle.js"></script>

    <!-- Speech SpeechSDK Authorization token -->
    <script>
    // Note: Replace the URL with a valid endpoint to retrieve
    //       authorization tokens for your subscription.
    var authorizationEndpoint = "token.php";
  
    function RequestAuthorizationToken() {
      if (authorizationEndpoint) {
        const a = new XMLHttpRequest();
        a.open("GET", authorizationEndpoint);
        a.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        a.send("");
        a.onload = function() {
            key.disabled = true;
            key.value = "using authorization token (hit F5 to refresh)";

            const token = JSON.parse(atob(this.responseText.split(".")[1]));
            regionOptions.value = token.region;
            authorizationToken = this.responseText;

            console.log("Got an authorization token: " + token);
        }
      }
    }
    </script>
  
    <!-- SpeechSDK USAGE -->
    <script>
        // On document load resolve the SpeechSDK dependency
        function Initialize(onComplete) {
            if (!!window.SpeechSDK) {
                document.getElementById('content').style.display = 'block';
                document.getElementById('warning').style.display = 'none';
                onComplete(window.SpeechSDK);
            }
        }
    </script>

    <!-- Browser Hooks -->
    <script>
        var hypothesisDiv, phraseDiv, statusDiv;
        var key, authorizationToken;
        var regionOptions;
        var languageOptions, formatOptions, inputSource, filePicker;
        var SpeechSDK;
        var recognizer;

        var reco;
        var sdkStartContinousRecognitionBtn, sdkStopContinousRecognitionBtn;
        var sdkStartContinousTranslationBtn, sdkStopContinousTranslationBtn;
        var sdkStartRecognizeOnceAsyncBtn, sdkStopRecognizeOnceAsyncBtn, languageTargetOptions, voiceOutput;
        var audioFile, audioFileValid;
        var soundContext = new AudioContext();

        document.addEventListener("DOMContentLoaded", function () {
            createBtn = document.getElementById("createBtn");
            sdkStartRecognizeOnceAsyncBtn = document.getElementById("speechsdkStartRecognizeOnceAsync");
            sdkStopRecognizeOnceAsyncBtn = document.getElementById("speechsdkStopRecognizeOnceAsync");
            sdkStartContinousRecognitionBtn = document.getElementById("speechsdkStartContinousRecognition");
            sdkStopContinousRecognitionBtn = document.getElementById("speechsdkStopContinousRecognition");
            sdkStartContinousTranslationBtn = document.getElementById("speechsdkStartContinousTranslation");
            sdkStopContinousTranslationBtn = document.getElementById("speechsdkStopContinousTranslation");
            phraseDiv = document.getElementById("phraseDiv");
            hypothesisDiv = document.getElementById("hypothesisDiv");
            statusDiv = document.getElementById("statusDiv");
            key = document.getElementById("key");
            languageOptions = document.getElementById("languageOptions");
            languageTargetOptions = document.getElementById("languageTargetOptions");
            voiceOutput = document.getElementById("voiceOutput");
            regionOptions = document.getElementById("regionOptions");
            formatOptions = document.getElementById("formatOptions");
            inputSource = document.getElementById("inputSource");
            filePicker = document.getElementById('filePicker');

            sdkStartContinousRecognitionBtn.addEventListener("click", function () {
                hypothesisDiv.innerHTML = "";
                phraseDiv.innerHTML = "";
                statusDiv.innerHTML = "";

                var audioConfig = audioFileValid ? SpeechSDK.AudioConfig.fromWavFileInput(audioFile) : SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
                var speechConfig;
                if(authorizationToken) {
                    speechConfig = SpeechSDK.SpeechConfig.fromAuthorizationToken(authorizationToken, regionOptions.value);
                } else {
                    if (key.value == "" || key.value == "YOUR_SPEECH_API_KEY") {
                        alert("Please enter your Cognitive Services Speech subscription key!");
                        return;
                    }
                    speechConfig = SpeechSDK.SpeechConfig.fromSubscription(key.value, regionOptions.value);
                }

                speechConfig.language = languageOptions.value;
                reco = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

                reco.recognizing = function (s, e) {
                    window.console.log(e);
                    hypothesisDiv.innerHTML = e.result.text;
                };

                reco.recognized = function (s, e) {
                    window.console.log(e);

                    statusDiv.innerHTML = "";
                    hypothesisDiv.innerHTML = "";
                    phraseDiv.innerHTML += e.result.text + "\r\n";
                };

                reco.sessionStarted = function (s, e) {
                    window.console.log(e);
                    statusDiv.innerHTML += "sessionStarted: " +  JSON.stringify(e);
                };

                reco.sessionStopped = function (s, e) {
                    window.console.log(e);
                    statusDiv.innerHTML += "sessionStopped: " +  JSON.stringify(e);
                };

                reco.speechStartDetected  = function (s, e) {
                    window.console.log(e);
                    statusDiv.innerHTML += "speechStartDetected: " + JSON.stringify(e);
                };

                reco.speechEndDetected  = function (s, e) {
                    window.console.log(e);
                    statusDiv.innerHTML += "speechEndDetected: " + JSON.stringify(e);
                };

                reco.startContinuousRecognitionAsync();

                sdkStartContinousRecognitionBtn.disabled = true;
                sdkStopContinousRecognitionBtn.disabled = false;
            });

            sdkStopContinousRecognitionBtn.addEventListener("click", function () {
                sdkStartContinousRecognitionBtn.disabled = false;
                sdkStopContinousRecognitionBtn.disabled = true;

                reco.stopContinuousRecognitionAsync(
                    function () {
                        reco.close();
                        reco = undefined;
                    },
                    function (err) {
                        reco.close();
                        reco = undefined;
                    });
            });

            sdkStartContinousTranslationBtn.addEventListener("click", function () {
                if (key.value == "" || key.value == "YOUR_SPEECH_API_KEY") {
                    alert("Please enter your Cognitive Services Speech subscription key!");
                    return;
                }

                hypothesisDiv.innerHTML = "";
                phraseDiv.innerHTML = "";
                statusDiv.innerHTML = "";

                var audioConfig = audioFileValid ? SpeechSDK.AudioConfig.fromWavFileInput(audioFile) : SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
                var speechConfig;
                if(authorizationToken) {
                    speechConfig = SpeechSDK.SpeechConfig.fromAuthorizationToken(authorizationToken, regionOptions.value);
                } else {
                    if (key.value == "" || key.value == "YOUR_SPEECH_API_KEY") {
                        alert("Please enter your Cognitive Services Speech subscription key!");
                        return;
                    }
                    speechConfig = SpeechSDK.SpeechConfig.fromSubscription(key.value, regionOptions.value);
                }

                speechConfig.language = languageOptions.value;
                speechConfig.setProperty(SpeechSDK.PropertyId.SpeechServiceConnection_TranslationFromLanguage, languageOptions.value);

    
                speechConfig.setProperty(SpeechSDK.PropertyId.SpeechServiceConnection_TranslationToLanguages, [languageTargetOptions.value.split(":")[0], languageOptions.value]);
                if (voiceOutput.checked) {
                    speechConfig.setProperty(SpeechSDK.PropertyId.SpeechServiceConnection_TranslationVoice, languageTargetOptions.value.replace(":", "-"));
                }

                reco = new SpeechSDK.TranslationRecognizer(speechConfig, audioConfig);

                reco.recognizing = function (s, e) {
                    window.console.log(e);
                    hypothesisDiv.innerHTML = JSON.stringify(e.result.translations.map.values);
                };

                reco.recognized = function (s, e) {
                    window.console.log(e);

                    statusDiv.innerHTML = "";
                    hypothesisDiv.innerHTML = "";
                    phraseDiv.innerHTML += JSON.stringify(e.result.translations.map.values) + "\r\n";
                };

                reco.synthesizing = function (s, e) {
                    window.console.log(e);

                    var source = soundContext.createBufferSource();
                    soundContext.decodeAudioData(e.result.audio, function(newBuffer) {
                        source.buffer = newBuffer;
                        source.connect(soundContext.destination);
                        source.start(0);
                    });

                    statusDiv.innerHTML = "playing audio";
                };

                reco.sessionStarted = function (s, e) {
                    window.console.log(e);
                    statusDiv.innerHTML += "sessionStarted: " +  JSON.stringify(e);
                };

                reco.sessionStopped = function (s, e) {
                    window.console.log(e);
                    statusDiv.innerHTML += "sessionStopped: " +  JSON.stringify(e);
                };

                reco.speechStartDetected = function (s, e) {
                    window.console.log(e);
                    statusDiv.innerHTML += "speechStartDetected: " + JSON.stringify(e);
                };

                reco.speechEndDetected = function (s, e) {
                    window.console.log(e);
                    statusDiv.innerHTML += "speechEndDetected: " + JSON.stringify(e);
                };
                reco.startContinuousRecognitionAsync();

                languageTargetOptions.disabled = true;
                sdkStartContinousTranslationBtn.disabled = true;
                sdkStopContinousTranslationBtn.disabled = false;
            });

            sdkStopContinousTranslationBtn.addEventListener("click", function () {
                languageTargetOptions.disabled = false;
                sdkStartContinousTranslationBtn.disabled = false;
                sdkStopContinousTranslationBtn.disabled = true;

                reco.stopContinuousRecognitionAsync(
                    function () {
                        reco.close();
                        reco = undefined;
                    },
                    function (err) {
                        reco.close();
                        reco = undefined;
                    });
            });

            sdkStartRecognizeOnceAsyncBtn.addEventListener("click", function () {
                if (key.value == "" || key.value == "YOUR_SPEECH_API_KEY") {
                    alert("Please enter your Cognitive Services Speech subscription key!");
                    return;
                }

                hypothesisDiv.innerHTML = "";
                phraseDiv.innerHTML = "";
                statusDiv.innerHTML = "";

                var audioConfig = audioFileValid ? SpeechSDK.AudioConfig.fromWavFileInput(audioFile) : SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
                var speechConfig;
                if(authorizationToken) {
                    speechConfig = SpeechSDK.SpeechConfig.fromAuthorizationToken(authorizationToken, regionOptions.value);
                } else {
                    if (key.value == "" || key.value == "YOUR_SPEECH_API_KEY") {
                        alert("Please enter your Cognitive Services Speech subscription key!");
                        return;
                    }
                    speechConfig = SpeechSDK.SpeechConfig.fromSubscription(key.value, regionOptions.value);
                }

                speechConfig.language = languageOptions.value;
                reco = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

                reco.recognizing = function (s, e) {
                    window.console.log(e);
                    hypothesisDiv.innerHTML = e.result.text;
                };

                reco.sessionStarted = function (s, e) {
                    window.console.log(e);
                    statusDiv.innerHTML += "sessionStarted: " +  JSON.stringify(e);
                };

                reco.sessionStopped = function (s, e) {
                    window.console.log(e);
                    statusDiv.innerHTML += "sessionStopped: " +  JSON.stringify(e);
                };

                reco.speechStartDetected = function (s, e) {
                    window.console.log(e);
                    statusDiv.innerHTML += "speechStartDetected: " + JSON.stringify(e);
                };

                reco.speechEndDetected = function (s, e) {
                    window.console.log(e);
                    statusDiv.innerHTML += "speechEndDetected: " + JSON.stringify(e);
                };

                // Note: this is how you can process the result directly
                //       rather then subscribing to the recognized
                //       event
                reco.recognizeOnceAsync(
                    function (result) {
                        window.console.log(result);

                        statusDiv.innerHTML = "";
                        hypothesisDiv.innerHTML = "";
                        phraseDiv.innerHTML += result.text + "\r\n";

                        sdkStopRecognizeOnceAsyncBtn.click();
                    },
                    function (err) {
                        window.console.log(err);

                        statusDiv.innerHTML = "";
                        hypothesisDiv.innerHTML = "";
                        phraseDiv.innerHTML += "ERROR: " + err;

                        sdkStopRecognizeOnceAsyncBtn.click();
                    });

                sdkStartRecognizeOnceAsyncBtn.disabled = true;
                sdkStopRecognizeOnceAsyncBtn.disabled = false;
            });

            sdkStopRecognizeOnceAsyncBtn.addEventListener("click", function () {
                sdkStartRecognizeOnceAsyncBtn.disabled = false;
                sdkStopRecognizeOnceAsyncBtn.disabled = true;

                reco.close();
                reco = undefined;
            });
            
            key.addEventListener("focus", function () {
               if (key.value == "YOUR_SPEECH_API_KEY") {
                   key.value = "";
               }
            });

            key.addEventListener("focusout", function () {
               if (key.value == "") {
                   key.value = "YOUR_SPEECH_API_KEY";
               }
            });

            inputSource.addEventListener("change", function () {
                audioFileValid = (inputSource.value === "File");

                if (inputSource.value === "File") {
                    filePicker.click();
                    return;
                }
            });

            filePicker.addEventListener("change", function () {
                audioFile = new SpeechSDK.FileInputStream(filePicker.files[0]);
            });

            Initialize(function (speechSdk) {
                SpeechSDK = speechSdk;
                sdkStartContinousRecognitionBtn.disabled = false;
                sdkStartRecognizeOnceAsyncBtn.disabled = false;

                // in case we have a function for getting an authorization token, call it.
                if (typeof RequestAuthorizationToken === "function") {
                    RequestAuthorizationToken();
                }
            });
        });
    </script>
</body>
</html>

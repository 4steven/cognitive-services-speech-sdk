parameters:
  buildParams: ""
  wheelParams: ""
  pythonIncludePathSuffix: ""
  postbuildsteps: []
steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: $(PythonVersion)
    addToPath: true
    architecture: $(SPEECHSDK_PYTHON_PLATFORM)
- bash: |
    python -m pip install --upgrade pip &&
    pip install virtualenv==16.1.0 scikit-build==0.8.1 wheel==0.32.3 strip-hints==0.1.1 &&
    python_executable_path=$(which python) &&
    python_include_path=$(dirname $python_executable_path)/include/${{ parameters.pythonIncludePathSuffix }} &&
    python setup.py bdist_wheel -G "$(SPEECHSDK_CMAKE_GENERATOR)" ${{ parameters.wheelParams }} -- \
        -DSPEECHSDK_TARGET_PLATFORM=$(SPEECHSDK_TARGET_PLATFORM) \
        -DSPEECHSDK_BUILD_TYPE=$(SPEECHSDK_BUILD_TYPE) \
        -DSPEECHSDK_VERSION=$(SPEECHSDK_SEMVER2NOMETA) \
        -DPYTHON_INCLUDE_DIR=$python_include_path ${{ parameters.buildParams }} &&
    mv dist build
  displayName: Build Python $(PythonVersion) wheel
- ${{ parameters.postbuildsteps }}
- bash: |
    set -u -e -x -o pipefail
    . ci/functions.sh
    patchSamplesFromTestConfig public_samples/samples/python/console \
      ci/test-config.json \
      -D luis-key=$(luis-westus-s0-201809-key1) \
      -D speech-key=$(NorthEuropeKeySkyman) \
      -D long-running=false
    cp tests/input/audio/*.wav public_samples/samples/python/console
  displayName: Prepare Python samples for testing
- template: test-during-build.yml
  parameters:
    testsToRun: python_unittests
    runTestArgs: ""
- bash: |
    mkdir -p "$(OutputDirectory)" &&
    cp -v build/*.whl "$(OutputDirectory)"
  displayName: Drop Python wheel
  condition: succeededOrFailed()
- task: PublishBuildArtifacts@1
  displayName: Publish drop
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: PythonBuild
    publishLocation: Container
  condition: succeededOrFailed()

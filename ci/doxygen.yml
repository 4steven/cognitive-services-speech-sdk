# Variables:
#   Version - version number to use
resources:
- repo: self
queue:
  name: Hosted macOS Preview
  demands: sh
steps:
- task: ms-devlabs.utilitytasks.task-Shellpp.Shell++@0
  inputs:
    type: InlineScript
    script: |
       set -e -o pipefail
       brew install doxygen
       cd ci/doxygen
       mkdir "$(Build.ArtifactStagingDirectory)/Doxygen"
       for lang in c cpp csharp java; do
         (
           cat ${lang}_doxygen.txt;
           echo PROJECT_NUMBER=$(Version);
           echo 'WARN_FORMAT="##''vso[task.logissue type=warning;sourcepath=$file;linenumber=$line;columnnumber=1]$text"';
           echo OUTPUT_DIRECTORY=$(Build.ArtifactStagingDirectory)/Doxygen
         ) | doxygen -
       done
       git clone https://github.com/sourcey/moxygen.git
       cd moxygen
       git checkout c00d16803a6dfc40796cd4b76271c481ed865243
       git apply ../0001-Provide-shortname-provide-plain.patch
       npm install
       cd ..
       node moxygen/bin/moxygen.js -o cppapi.md -t ./moxygen_template/cpp -a $(Build.ArtifactStagingDirectory)/Doxygen/cppxml
       powershell -NoProfile -NoLogo -ExecutionPolicy Bypass -NonInteractive doxmox2docs.ps1 \
         -DoxygenIndexXml $(Build.ArtifactStagingDirectory)/Doxygen/cppxml/index.xml \
         -MoxygenApiMd cppapi.md \
         -OutputDir $(Build.ArtifactStagingDirectory)/Doxygen/cppmd
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)/Doxygen'
    ArtifactName: Doxygen
    publishLocation: Container

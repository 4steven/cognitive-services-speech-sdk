#
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT license.
#
parameters:
  continueOnTestFailure: false
  buildType: dev

jobs:

- job: Pre
  pool:
    name: Hosted Ubuntu 1604
  timeoutInMinutes: 30
  variables:
    CG_RAN: false
  steps:
  - checkout: self
    fetchDepth: 2
    submodules: false
    lfs: false
  - bash: ./ci/set-variables.sh
    displayName: Set variables
    name: var
  - bash: |
      . ci/functions.sh
      vsts_updatebuildnumber $(SPEECHSDK_SEMVER2NOMETA)
      vsts_addbuildtag $(SPEECHSDK_BUILD_TYPE)
    displayName: Set build number and tag
  - bash: |
      ./ci/check-git-head.sh &&
      perl ci/check-docfx-codetags.pl public_samples
    displayName: Repository checks
  - task: ms.vss-governance-buildtask.governance-build-task-component-detection.ComponentGovernanceComponentDetection@0
    displayName: 'Component Detection'
    condition: and(succeeded(), eq(variables['SPEECHSDK_BUILD_TYPE'], 'int'))

- job: WindowsSdlBuild
  dependsOn: Pre
  condition: and(succeeded('Pre'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' WindowsSdlBuild '))
  pool:
    name: Hosted VS2017
  timeoutInMinutes: 120
  variables:
    BuildPlatform: x64
    BuildConfiguration: Release
    SPEECHSDK_BUILD_PHASES: $[ dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'] ]
  steps:
  - script: |
      echo ##vso[task.prependpath]C:\Program Files\Git\mingw64\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\usr\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\bin
    displayName: Work around for recent broken system path on Hosted VS2017 build agents.
    # see ICM https://icm.ad.msft.net/imp/v3/incidents/details/171621867/home
    # see PR  https://github.com/actions/virtual-environments/pull/211/files that broke many bash commands on Hosted VS2017 build agents.
  - task: ms-devlabs.utilitytasks.task-Shellpp.Shell++@0
    displayName: Set Windows target platform (Windows-x64)
    inputs:
      type: InlineScript
      script: |
        . ci/functions.sh
        if [[ "$(BuildPlatform)" == Win32 ]]; then
          vsts_setvar SPEECHSDK_TARGET_PLATFORM "Windows-x86"
          vsts_setvar SPEECHSDK_CMAKE_GENERATOR "Visual Studio 15"
        else
          vsts_setvar SPEECHSDK_TARGET_PLATFORM "Windows-x64"
          vsts_setvar SPEECHSDK_CMAKE_GENERATOR "Visual Studio 15 Win64"
        fi
        vsts_setvar SPEECHSDK_BUILD_CONFIGURATION "$(BuildConfiguration)"
        vsts_setvar SPEECHSDK_ENABLE_UNIDEC true
        vsts_setvar VSTS_TOKEN "$(System.AccessToken)"
  - bash: ./ci/set-variables.sh
    displayName: Set variables
  - task: NuGetToolInstaller@0
    displayName: Use NuGet $(SPEECHSDK_NUGET_VERSION)
    inputs:
      versionSpec: $(SPEECHSDK_NUGET_VERSION)
  - bash: ./ci/install-build-dependencies.sh
    displayName: Install build dependencies
  - task: CMake@1
    displayName: Generate solution
    inputs:
      cmakeArgs: '-G "$(SPEECHSDK_CMAKE_GENERATOR)" -DEXTENSION_UNIDEC_ENABLED=$(SPEECHSDK_ENABLE_UNIDEC) -DSPEECHSDK_TARGET_PLATFORM=$(SPEECHSDK_TARGET_PLATFORM) -DSPEECHSDK_BUILD_TYPE=$(SPEECHSDK_BUILD_TYPE) -DSPEECHSDK_VERSION=$(SPEECHSDK_SEMVER2NOMETA) -DSPECTRE_MITIGATION=$(SPEECHSDK_SPECTRE_MITIGATION) ..'
  ## We have to build inside Semmle, not with the build task, so Semmle can do log scanning.
  - task: Semmle@0
    displayName: 'Run Semmle for Java'
    timeoutInMinutes: 40
    continueOnError: false
    inputs:
      sourceCodeDirectory: '$(Build.SourcesDirectory)\source'
      cleanupBuildCommands: 'cd $(Build.SourcesDirectory)\build && "C:\Program Files\CMake\bin\cmake.exe" --clean .'
      #buildCommands: '"%ProgramFiles(x86)%\Microsoft Visual Studio\2017\Enterprise\Common7\Tools\VsMSBuildCmd.bat" && msbuild $(BUILD.SourcesDirectory)\build\source\bindings\java\com.microsoft.cognitiveservices.speech.sln /nologo /t:Clean /maxcpucount /p:platform=$(BuildPlatform) /p:configuration=$(BuildConfiguration)'
      buildCommands: 'cd $(Build.SourcesDirectory)\build && "C:\Program Files\CMake\bin\cmake.exe" --build .'
      language: 'java'
      includeNodeModules: false
      querySuite: 'Required'
      timeout: '3000'
      ram: '16384'
      addProjectDirToScanningExclusionList: true
  ## We have to build with VSBuild@1 in order t make Roslyn happy.
  - task: VSBuild@1
    displayName: Build solution
    inputs:
      solution: 'build/carbon.sln'
      platform: '$(BuildPlatform)'
      configuration: '$(BuildConfiguration)'
      clean: true
      maximumCpuCount: true
      # Needed for SDL:
      createLogFile: true
  # Checks BEGIN
  - bash: |
      rm -f source/bindings/python/test.audio.utterances.json
      ls -al source/bindings/python
    displayName: Remove test data
  - task: securedevelopmentteam.vss-secure-development-tools.build-task-roslynanalyzers.RoslynAnalyzers@2
    displayName: 'Run Roslyn Analyzers'
    # Note: source/bindings/csharp/CMakeLists.txt (Microsoft.CognitiveServices.Speech.csharp.csproj.template)
    #       does _not_ pick up on Roslyn analyzers options set here; for now
    #       these need to be manually kept in sync.
  - task: securedevelopmentteam.vss-secure-development-tools.build-task-binskim.BinSkim@3
    displayName: 'BinSkim (can pass only with Spectre mitigation)'
    inputs:
      arguments: 'analyze build/bin/$(BuildConfiguration)/*.dll --recurse'
  - task: securedevelopmentteam.vss-secure-development-tools.build-task-antimalware.AntiMalware@3
    displayName: 'AntiMalware'
    inputs:
      FileDirPath: '.'
      EnableServices: true
      SignatureFreshness: ThreeDays
      TreatStaleSignatureAs: Warning
  - task: securedevelopmentteam.vss-secure-development-tools.build-task-apiscan.APIScan@1
    displayName: 'APIScan'
    inputs:
      softwareName: 'Cognitive Services Speech SDK'
      softwareVersionNum: 1.0
      isLargeApp: false
    enabled: false
  - task: securedevelopmentteam.vss-secure-development-tools.build-task-credscan.CredScan@2
    displayName: 'CredScan (source-scan, dir: all)'
    inputs:
      suppressionsFile: 'ci/sdl/LocalSuppression.json'
      debugMode: false
  - task: securedevelopmentteam.vss-secure-development-tools.build-task-policheck.PoliCheck@1
    displayName: 'PoliCheck (source-scan, dir: source)'
    inputs:
      targetType: F
      targetArgument: 'source'
      result: PoliCheckSource.xml
      optionsFC: 1
  - task: securedevelopmentteam.vss-secure-development-tools.build-task-policheck.PoliCheck@1
    displayName: 'PoliCheck (source-scan, dir: public samples)'
    inputs:
      targetType: F
      targetArgument: 'public_samples'
      termTypeT: 0001aCustom
      result: PoliCheckSamples.xml
      SOMEnabled: true
      optionsFC: 1
  - task: securedevelopmentteam.vss-secure-development-tools.build-task-fxcop.FxCop@2
    displayName: 'Run FxCop'
    inputs:
      inputType: Basic
      targets: 'build/bin/$(BuildConfiguration)/net461'
      disableRules: 'Microsoft.Globalization#CA2101'
      verbose: true
  - bash: rm -rf build/source/bindings/java/javadoc
    displayName: Remove JavaDoc folder
  - task: securedevelopmentteam.vss-secure-development-tools.build-task-moderncop.ModernCop@2
    displayName: 'ModernCop (managed JS code)'
    inputs:
      InputType: Basic
      OutputFormat: red
  - task: securedevelopmentteam.vss-secure-development-tools.build-task-autoapplicability.AutoApplicability@1
    displayName: 'Run AutoApplicability'
    inputs:
      ApplyRules: All
      ExternalRelease: true
  # Currently we do not have TypeScript source in this repository. Keeping the task here with default options.
  - task: securedevelopmentteam.vss-secure-development-tools.build-task-tslint.TSLint@1
    displayName: 'Run TSLint'
  - task: securedevelopmentteam.vss-secure-development-tools.build-task-prefast.SDLNativeRules@2
    displayName: 'Run the PREfast SDL Native Rules for MSBuild'
  # Checks END
  # Publish artifact and fail the build if necessary
  - task: securedevelopmentteam.vss-secure-development-tools.build-task-publishsecurityanalysislogs.PublishSecurityAnalysisLogs@2
    displayName: 'Publish Security Analysis Logs'
    inputs:
      AllTools: true
  - task: securedevelopmentteam.vss-secure-development-tools.build-task-postanalysis.PostAnalysis@1
    displayName: 'SDL: Post Analysis (w/ TsaUpload)'
    inputs:
      AllTools: true
    continueOnError: true
    condition: contains(variables['SPEECHSDK_BUILD_PHASES'], ' TsaUpload ')

# Phase responsible to upload to TSA database
- job: TsaUpload
  dependsOn: [Pre, WindowsSdlBuild]
  condition: and(succeeded('Pre', 'WindowsSdlBuild'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' TsaUpload '))

  pool:
    name: Hosted VS2017
  timeoutInMinutes: 30
  steps:
  - script: |
      echo ##vso[task.prependpath]C:\Program Files\Git\mingw64\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\usr\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\bin
    displayName: Work around for recent broken system path on Hosted VS2017 build agents.
    # see ICM https://icm.ad.msft.net/imp/v3/incidents/details/171621867/home
    # see PR  https://github.com/actions/virtual-environments/pull/211/files that broke many bash commands on Hosted VS2017 build agents.
  - task: DownloadBuildArtifacts@0
    displayName: 'Downloading CodeAnalysisLogs Artifacts'
    inputs:
      artifactName: CodeAnalysisLogs
      downloadPath: $(System.ArtifactsDirectory)/In
  - powershell: |
     $logDir = "$(Agent.BuildDirectory)/_sdt/logs"
     if (Test-Path $logDir) {
       Remove-Item -Recurse -Force $logDir
     }
     if (-not (Test-Path (Split-Path $logDir))) {
       New-Item -ItemType Directory (Split-Path $logDir)
     }
     Move-Item $(System.ArtifactsDirectory)/In/CodeAnalysisLogs $logDir -verbose -force
    errorActionPreference: continue
    displayName: 'Move logs to target location'
  - task: securedevelopmentteam.vss-secure-development-tools.build-task-uploadtotsa.TSAUpload@1
    displayName: 'TSA upload to Codebase: Carbon_master Version: TsaV2'
    inputs:
      tsaVersion: TsaV2
      codebase: NewOrUpdate
      codeBaseName: 'Carbon_master'
      notificationAlias: 'cdev@microsoft.com'
      codeBaseAdmins: 'REDMOND\cbasoglu;REDMOND\brianem'
      instanceUrlForTsaV2: MSASG
      projectNameMSASG: 'Bing_and_IPG'
      areaPath: 'Bing_and_IPG\Speech\Service\Client\SpeechSDK'
      iterationPath: 'Bing_and_IPG\Backlog'
      uploadAPIScan: false
    continueOnError: true
    condition: always()

# This phase is responsible for running CompEval test (Windows C# only)
# For now, it is triggered by a separate build definition in AzureDevOps: "CompEval Test"
- job: CompEvalTest
  dependsOn: [Pre, WindowsBuild]
  condition: and(succeeded('Pre', 'WindowsBuild'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' CompEvalTest '))
  pool:
    name: Hosted VS2017
  timeoutInMinutes: 400
  steps:
  - script: |
      echo ##vso[task.prependpath]C:\Program Files\Git\mingw64\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\usr\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\bin
    displayName: Work around for recent broken system path on Hosted VS2017 build agents.
    # see ICM https://icm.ad.msft.net/imp/v3/incidents/details/171621867/home
    # see PR  https://github.com/actions/virtual-environments/pull/211/files that broke many bash commands on Hosted VS2017 build agents.
  - bash: ./ci/set-variables.sh
    displayName: Set variables
  - task: DownloadBuildArtifacts@0
    displayName: 'Downloading Windows artifacts'
    inputs:
      artifactName: Windows
      downloadPath: $(System.ArtifactsDirectory)\In
  - powershell: |
      $tools = Start-Process -FilePath "C:\Program Files (x86)\Microsoft SDKs\Azure\AzCopy\AzCopy.exe" -Wait -PassThru -NoNewWindow -ArgumentList /Source:https://csspeechtestdata.blob.core.windows.net/tools/NormAndAlign, /Dest:CompEvalRun\, /SourceKey:$(TestDataStorageKey), /S, /Y, /XO
      $data = Start-Process -FilePath "C:\Program Files (x86)\Microsoft SDKs\Azure\AzCopy\AzCopy.exe" -Wait -PassThru -NoNewWindow -ArgumentList /Source:https://csspeechtestdata.blob.core.windows.net/datasets/CompEval, /Dest:CompEvalRun\, /SourceKey:$(TestDataStorageKey), /S, /Y, /XO
      if (($tools.ExitCode -ne 0) -or ($data.ExitCode -ne 0)) {
          throw "an error occurred"
      }
    displayName: 'Downloading CompEval data'
  - powershell: |
      cd CompEvalRun\CompEval\en-US
      Remove-Item -Verbose c*.wav,d*.wav,e*.wav,f*.wav
    displayName: Delete 1/4 of the files
  - bash: |
      # --build-dir is used as a drop directory here
      ./ci/run-tests.sh \
        --build-dir "$(cygpath -au "$(Build.ArtifactStagingDirectory)")"/In \
        --platform Windows-x64-Release \
        --timeout 400m \
        -D output_dir=CompEvalRun -- compeval_tests
    displayName: 'Transcription'

- template: build-windows.yml
  parameters:
    crt: PUBLIC_VCRT
    name: Windows
    kws: true
    continueOnTestFailure: ${{ parameters.continueOnTestFailure }}

- template: build-windows.yml
  parameters:
    crt: OS_UCRT
    name: WindowsOS
    kws: false
    suffix: .os
    continueOnTestFailure: ${{ parameters.continueOnTestFailure }}

- job: WindowsUwpBuild
  dependsOn: Pre
  condition: and(succeeded('Pre'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' WindowsUwpBuild '))
  pool:
    name: Hosted VS2017
  timeoutInMinutes: 30
  strategy:
    maxParallel: 8
    matrix:
      arm64_debug:
        BuildPlatform: ARM64
        BuildConfiguration: Debug
      arm64_release:
        BuildPlatform: ARM64
        BuildConfiguration: Release
      arm32_release:
        BuildPlatform: ARM
        BuildConfiguration: Release
      arm32_debug:
        BuildPlatform: ARM
        BuildConfiguration: Debug
      x64_debug:
        BuildPlatform: x64
        BuildConfiguration: Debug
      x64_release:
        BuildPlatform: x64
        BuildConfiguration: Release
      x86_release:
        BuildPlatform: Win32
        BuildConfiguration: Release
      x86_debug:
        BuildPlatform: Win32
        BuildConfiguration: Debug
  steps:
  - script: |
      echo ##vso[task.prependpath]C:\Program Files\Git\mingw64\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\usr\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\bin
    displayName: Work around for recent broken system path on Hosted VS2017 build agents.
    # see ICM https://icm.ad.msft.net/imp/v3/incidents/details/171621867/home
    # see PR  https://github.com/actions/virtual-environments/pull/211/files that broke many bash commands on Hosted VS2017 build agents.
  - bash: |
      set -u -e -o pipefail
      . ci/functions.sh
      IFS=$' \t\n\r' read build_id should_be_empty < external/uwp_ssl/build_id.txt
      # checks
      [[ -z $should_be_empty ]]
      printf '%d' "$build_id" > /dev/null
      vsts_setvar SPEECHSDK_UWP_OPENSSL_BUILD_ID "$build_id"
    displayName: Get UWP OpenSSL build ID
  - task: DownloadBuildArtifacts@0
    displayName: Download UWP OpenSSL build artifact
    inputs:
      buildType: specific
      project: 'e71f1362-9c7d-488b-99c7-3376db8d3302' # Skyman
      pipeline: 8520 # Yml - Carbon UWP openssl
      buildVersionToDownload: specific
      buildId: $(SPEECHSDK_UWP_OPENSSL_BUILD_ID)
      artifactName: speechsdk-static-release
  - script: |
      move $(System.ArtifactsDirectory)\speechsdk-static-release\include external\uwp_ssl\include && ^
      move $(System.ArtifactsDirectory)\speechsdk-static-release\lib external\uwp_ssl\lib && ^
      dir /s/a/b external\uwp_ssl
    displayName: Move UWP OpenSSL into appropriate place
  - task: ms-devlabs.utilitytasks.task-Shellpp.Shell++@0
    displayName: Set Windows target platform (Windows-x86 or Windows-x64)
    inputs:
      type: InlineScript
      script: |
        . ci/functions.sh
        if [[ "$(BuildPlatform)" == Win32 ]]; then
          vsts_setvar SPEECHSDK_TARGET_PLATFORM "WindowsUwp-x86"
        elif [[ "$(BuildPlatform)" == ARM ]]; then
          vsts_setvar SPEECHSDK_TARGET_PLATFORM "WindowsUwp-arm32"
        elif [[ "$(BuildPlatform)" == ARM64 ]]; then
          vsts_setvar SPEECHSDK_TARGET_PLATFORM "WindowsUwp-arm64"
        else
          vsts_setvar SPEECHSDK_TARGET_PLATFORM "WindowsUwp-x64"
        fi
        vsts_setvar SPEECHSDK_CMAKE_GENERATOR "Visual Studio 15"
        vsts_setvar SPEECHSDK_BUILD_CONFIGURATION "$(BuildConfiguration)"
        vsts_setvar SPEECHSDK_ENABLE_KWS true
        vsts_setvar SPEECHSDK_ENABLE_UNIDEC true
        vsts_setvar EXTENSION_AUDIOCOMPRESSION_ENABLED true
        vsts_setvar VSTS_TOKEN "$(System.AccessToken)"
  - bash: . ci/functions.sh && ./ci/set-variables.sh
  - task: NuGetToolInstaller@0
    displayName: Use NuGet $(SPEECHSDK_NUGET_VERSION)
    inputs:
      versionSpec: $(SPEECHSDK_NUGET_VERSION)
  - bash: ./ci/install-build-dependencies.sh
    displayName: Install build dependencies
  - template: get-kws-artifact.yml
    parameters:
      enableVariable: SPEECHSDK_ENABLE_KWS
      os: Windows
  - bash: |
      rm -f ./tests/test.subscriptions.regions.json
      cat > ./tests/test.subscriptions.regions.json <<HEREDOC
        $(KEYS_AND_REGIONS)
      HEREDOC
    displayName: Write Subscriptions Regions Data
  - task: CMake@1
    displayName: Generate solution
    inputs:
      cmakeArgs: >-
        -G "$(SPEECHSDK_CMAKE_GENERATOR)" -A "$(BuildPlatform)"
        -DSPEECHSDK_TARGET_PLATFORM=$(SPEECHSDK_TARGET_PLATFORM)
        -DSPEECHSDK_BUILD_TYPE=$(SPEECHSDK_BUILD_TYPE)
        -DSPEECHSDK_VERSION=$(SPEECHSDK_SEMVER2NOMETA)
        -DEXTENSION_KWS_ENABLED=$(SPEECHSDK_ENABLE_KWS)
        -DEXTENSION_UNIDEC_ENABLED=$(SPEECHSDK_ENABLE_UNIDEC)
        -DEXTENSION_AUDIOCOMPRESSION_ENABLED=$(EXTENSION_AUDIOCOMPRESSION_ENABLED)
        ..
  - task: VSBuild@1
    displayName: Build solution
    inputs:
      solution: 'build/carbon.sln'
      platform: '$(BuildPlatform)'
      configuration: '$(BuildConfiguration)'
      clean: true
      maximumCpuCount: true
  - task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
    displayName: 'Sign Windows C++ and C# binaries'
    inputs:
      ConnectedServiceName: 'Speech SDK ESRP Signing Alternate'
      FolderPath: 'build/bin/$(BuildConfiguration)'
      Pattern: 'Microsoft.CognitiveServices.Speech.core.dll,Microsoft.CognitiveServices.Speech.csharp.dll,Microsoft.CognitiveServices.Speech.extension.kws.dll,Microsoft.CognitiveServices.Speech.extension.silk_codec.dll'
      signConfigType: inlineSignParams
      inlineOperation: $(SIGN_PARAMS_DLL)
    condition: and(succeeded(), eq(variables['SPEECHSDK_SIGN'], 'true'))
  - task: ms-devlabs.utilitytasks.task-Shellpp.Shell++@0
    displayName: Create drop files
    inputs:
      type: FilePath
      scriptPath: './ci/drop/bindrop.sh'
      args: '$(BuildPlatform) $(BuildConfiguration) $(Build.ArtifactStagingDirectory)/$(BuildPlatform)/$(BuildConfiguration) false UWP'
  - task: PublishBuildArtifacts@1
    displayName: Publish drop
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: WindowsUwp
      publishLocation: Container

- template: java-jre-package.yml
  parameters:
    continueOnTestFailure: ${{ parameters.continueOnTestFailure }}
    macArtifactName: macOS

- template: java-jre-package.yml
  parameters:
    continueOnTestFailure: ${{ parameters.continueOnTestFailure }}
    macArtifactName: macOSProxy
    javaArtifactSuffix: "MacOSProxy"

- template: java-jre-package-test.yml
  parameters:
    name: JavaJrePackageLinuxTest
    vmImage: 'ubuntu-16.04'
    extraSteps:
      - bash: |
          rm -f ./tests/test.subscriptions.regions.json
          cp ./tests/test.defaults.json ./
          cp ./tests/test.audio.utterances.json ./
          cat > ./tests/test.subscriptions.regions.json <<HEREDOC
            $(KEYS_AND_REGIONS)
          HEREDOC
          cp ./tests/test.subscriptions.regions.json ./
          cp -rf ./tests/input .
        displayName: Write Subscriptions Regions Data
      - bash: |
          set -u -e -o pipefail
          . ci/functions.sh
          perl ci/patch-samples-pkg.pl "$(SPEECHSDK_SEMVER2NOMETA)" public_samples
          java -version
          cp ./ci/jsonsettings.py .
          patchSample public_samples/quickstart/java/jre/from-microphone
          patchSample public_samples/quickstart/java/jre/text-to-speech
          patchSample public_samples/quickstart/java/jre/translate-speech-to-text
          patchSample public_samples/quickstart/java/jre/virtual-assistant
          patchSample public_samples/samples/java/jre/console
          ./ci/run-maven.sh public_samples "$(MavenRoot)"
        displayName: Patch and build samples
      - template: get-docker-image.yml
        parameters:
          imageBase: oobejre_ubuntu1604_x64 oobejre_ubuntu1804_x64 oobejre_debian9_x64 oobejre_centos7_x64 oobejre_centos8_x64
          outvarImage: DOCKER_IMAGES
      - bash: |
          set -u -e -o pipefail
          . ci/functions.sh
          cp "$(PathToJar)" $(Build.Repository.LocalPath) || exitWithFailure "cp failed"
          #
          ERRORS=0
          for i in $(DOCKER_IMAGES); do
            ./ci/samples/test-quickstart-java-jre.sh "$i" "$(JarName)" ||
              { ((++ERRORS)); vsts_logissue error "Running quickstart/java-jre for image $i failed."; }
            #
            # Skip other samples on non-Ubuntu 16.04 in dev builds
            [[ $SPEECHSDK_BUILD_TYPE = dev && $i != *_ubuntu1604_* ]] ||
              ./ci/samples/test-samples-java-jre-console.sh "$i" "$(JarName)" ||
                { ((++ERRORS)); vsts_logissue error "Running samples/java/jre/console for image $i failed."; }
          done
          #
          [[ $ERRORS == 0 ]] || exitWithError "Not all samples ran successfully."
        condition: eq(variables['SPEECHSDK_RUN_TESTS'], 'true')
        displayName: Test samples

- template: java-jre-package-test.yml
  parameters:
    name: JavaJrePackageOsxUnitTest
    vmImage: 'macOS-10.15'
    extraSteps:
      - task: DownloadBuildArtifacts@0
        displayName: 'Downloading macOS Java test'
        inputs:
          artifactName: macOS
          downloadPath: $(Build.ArtifactStagingDirectory)/In
          Pattern: '*.jar'
      - bash: |
          rm -f ./tests/test.subscriptions.regions.json
          cp ./tests/test.defaults.json ./
          cp ./tests/test.audio.utterances.json ./
          cat > ./tests/test.subscriptions.regions.json <<HEREDOC
            $(KEYS_AND_REGIONS)
          HEREDOC
          cp ./tests/test.subscriptions.regions.json ./
          cp -rf ./tests/input .
        displayName: Write Subscriptions Regions Data
      - bash: |
          set -e
          . ci/functions.sh
          testJarFile="$(Build.ArtifactStagingDirectory)/In/macOS/Release/private/bin/com.microsoft.cognitiveservices.speech.tests.jar"
          [[ -f ${testJarFile} ]]
          [[ -f $(PathToJar) ]]
          # set +e to allow capturing exit codes
          set +e
          java -version
          for retry in {0..3}; do
              java \
              -cp $(printf "%s:" \
                "$(PathToJar)" \
                "${testJarFile}" \
                "external/junit/junit-4.12.jar" \
                "external/junit/hamcrest-core-1.3.jar" \
                "external/json/gson-2.8.6.jar") \
              -DTestOutputFilename=test-java-unittests-package-$retry.xml \
              tests.runner.Runner \
              tests.AllTests
            exitCode=$?
            if [[ $exitCode == 0 ]]; then
              echo "Test suite passed, RetryCount( $retry )"
              break
            else
              echo "Test suite failed during retry( $retry )."
              vsts_logissue warning "Test suite failed during retry( $retry )."
              sleep 2s
            fi
          done
          set -e
          exit ${exitCode}
        displayName: Run unit test
        condition: eq(variables['SPEECHSDK_RUN_TESTS'], 'true')
        continueOnError: ${{ parameters.continueOnTestFailure }}
      - task: PublishTestResults@2
        inputs:
          testResultsFiles: '**/test-*.xml'
        condition: and(succeededOrFailed(), eq(variables['SPEECHSDK_RUN_TESTS'], 'true'))
        displayName: Publish test results

- job: NuGet
  variables:
    HAS_OS_BUILD: $[contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' WindowsOSBuild ')]
  dependsOn: [Pre, LinuxBuild, LinuxDockerBuild, WindowsBuild, WindowsOSBuild, WindowsUwpBuild, macOSBuild, AndroidBuild, IosBuild]
  condition: |
    and(
      succeeded('Pre', 'LinuxBuild', 'LinuxDockerBuild', 'WindowsBuild', 'WindowsUwpBuild', 'macOSBuild', 'AndroidBuild', 'IosBuild'),
      xor(
        succeeded('WindowsOSBuild'),
        not(contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' WindowsOSBuild '))
      ),
      contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' NuGet ')
    )
  pool:
    name: Hosted VS2017
  timeoutInMinutes: 30
  steps:
  - script: |
      echo ##vso[task.prependpath]C:\Program Files\Git\mingw64\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\usr\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\bin
    displayName: Work around for recent broken system path on Hosted VS2017 build agents.
    # see ICM https://icm.ad.msft.net/imp/v3/incidents/details/171621867/home
    # see PR  https://github.com/actions/virtual-environments/pull/211/files that broke many bash commands on Hosted VS2017 build agents.
  - checkout: self
    fetchDepth: 2
    submodules: false
    lfs: false
  - bash: ./ci/set-variables.sh
    displayName: Set variables
  - task: DownloadBuildArtifacts@0
    displayName: Downloading artifacts
    inputs:
      downloadPath: $(System.ArtifactsDirectory)\In
      downloadType: specific
      itemPattern: |
        @(Android|Linux|Windows|WindowsOS|WindowsUwp)/*/Release/**
        @(iOS|macOS)/Release/**
        @(iOS|macOS)/Debug/**
        !**/libunstripped*/**
        !**/*.dSYM.zip
  - powershell: |
      Get-WmiObject Win32_Volume |
        Format-Table `
          driveletter,
          @{Label = "freespacegb"; Expression = {$_.freespace / 1gb}},
          @{Label = "capacitygb"; Expression = {$_.capacity / 1gb}}
    displayName: Get disk space
  - task: NuGetToolInstaller@0
    displayName: Use NuGet $(SPEECHSDK_NUGET_VERSION)
    inputs:
      versionSpec: $(SPEECHSDK_NUGET_VERSION)
  - bash: |
      . ci/functions.sh
      vsts_setvar ZipBasename "SpeechSDK-Samples-$(SPEECHSDK_SEMVER2NOMETA)"
    displayName: 'Set variables'
  - task: ms-devlabs.utilitytasks.task-Shellpp.Shell++@0
    inputs:
      type: FilePath
      scriptPath: './ci/nuget/pack.sh'
      args: './ci/nuget/carbon.nuspec $(Build.Repository.LocalPath) $(System.ArtifactsDirectory)\In $(SPEECHSDK_SEMVER2NOMETA) $(Build.ArtifactStagingDirectory)\Windows'
    displayName: Create public NuGet
  - task: ms-devlabs.utilitytasks.task-Shellpp.Shell++@0
    inputs:
      type: FilePath
      scriptPath: './ci/nuget/pack.sh'
      args: './ci/nuget/carbon_os.nuspec $(Build.Repository.LocalPath) $(System.ArtifactsDirectory)\In $(SPEECHSDK_SEMVER2NOMETA) $(Build.ArtifactStagingDirectory)\WindowsOS true'
    displayName: Create OS NuGet
    condition: and(succeeded(), eq(variables['HAS_OS_BUILD'], 'true'))
  - task: ms-devlabs.utilitytasks.task-Shellpp.Shell++@0
    inputs:
      type: FilePath
      scriptPath: './ci/nuget/pack.sh'
      args: './ci/nuget/carbon_xamarin_ios.nuspec $(Build.Repository.LocalPath) $(System.ArtifactsDirectory)\In $(SPEECHSDK_SEMVER2NOMETA) $(Build.ArtifactStagingDirectory)\Windows'
    displayName: Create public NuGet for Xamarin iOS
  # We could / should generate this elsewhere? Doesn't only apply to Windows + NuGet anymore...
  - task: ms-devlabs.utilitytasks.task-Shellpp.Shell++@0
    inputs:
      type: InlineScript
      script: |
         set -e -x -o pipefail
         # Drop is not needed anymore
         rm -rf "$(cygpath -au "$(System.ArtifactsDirectory)\In")"
         git clean -fdx public_samples
         perl ci/patch-samples-pkg.pl "$(SPEECHSDK_SEMVER2NOMETA)" public_samples
         cp --verbose --recursive --preserve public_samples "$(ZipBasename)"
         NOW=$(date -Iseconds)
         find "$(ZipBasename)" | xargs touch --date=$NOW
    displayName: 'Create directory with patched samples'
  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: $(ZipBasename)
      includeRootFolder: true
      archiveType: zip
      archiveFile: $(Build.ArtifactStagingDirectory)/Windows/$(ZipBasename).zip
    displayName: 'Create .zip'
  - bash: |
      ./ci/nuget/restore-from-local.sh "$(cygpath -au "$(Build.ArtifactStagingDirectory)/Windows")" public_samples
    displayName: 'Test - restore packages'
  - bash: |
      ls -R -a public_samples/quickstart/cpp/windows/from-blob
    displayName: 'Test - Dump folder content'
  # Note: for now building any platform. In the future, should build all available.
  - task: VSBuild@1
    inputs:
      solution: 'public_samples/**/*.sln'
      maximumCpuCount: true
    displayName: 'Test - build solutions'
  - task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
    inputs:
      ConnectedServiceName: 'Speech SDK ESRP Signing Alternate'
      FolderPath: '$(Build.ArtifactStagingDirectory)/Windows'
      Pattern: '*.nupkg'
      signConfigType: inlineSignParams
      inlineOperation: |
        [
          {
            "keyCode": "CP-401405",
            "operationSetCode": "NuGetSign",
            "parameters": [ ],
            "toolName": "sign",
            "toolVersion": "1.0"
          },
          {
            "keyCode": "CP-401405",
            "operationSetCode": "NuGetVerify",
            "parameters": [ ],
            "toolName": "sign",
            "toolVersion": "1.0"
          }
        ]
    condition: eq(variables['SPEECHSDK_SIGN'], 'true')
  - task: ms-devlabs.utilitytasks.task-Shellpp.Shell++@0
    enabled: false
    inputs:
      type: InlineScript
      script: |
         . ci/functions.sh
         set -e -o pipefail
         SHA256_SUM="$(sha256sum "$(cygpath -au "$(Build.ArtifactStagingDirectory)/$(ZipBasename).zip")" | cut -f1 -d' ')"
         # N.B. two spaces in the next line intentional
         echo "$SHA256_SUM  $(ZipBasename).zip"
         vsts_setvar SAMPLES_SHA256SUM "$SHA256_SUM"
         # checksum is not yet used...
    displayName: 'Compute SHA256 for .zip'
  - task: NuGetCommand@2
    displayName: NuGet push to VSTS feed
    inputs:
      command: push
      publishVstsFeed: $(SPEECHSDK_VSTS_FEED)
      packagesToPush: '$(Build.ArtifactStagingDirectory)/**/*.symbols.nupkg'
      includeSymbols: true
    condition: eq(variables['SPEECHSDK_NUGET_VSTS_PUSH'],'true')
  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/Windows'
      ArtifactName: Windows
      publishLocation: Container
    condition: succeededOrFailed()
    displayName: 'Publish .zip and .nupkg'
  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/WindowsOS'
      ArtifactName: WindowsOS
      publishLocation: Container
    condition: and(succeededOrFailed(), eq(variables['HAS_OS_BUILD'], 'true'))
    displayName: 'Publish OS .nupkg'

- job: WackTest
  dependsOn: [Pre, NuGet]
  condition: and(succeeded('Pre', 'NuGet'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' WackTest '))
  pool:
    name: Hosted VS2017
  timeoutInMinutes: 30
  variables:
    UwpSampleDir: public_samples/quickstart/csharp/uwp/from-microphone
  steps:
  - script: |
      echo ##vso[task.prependpath]C:\Program Files\Git\mingw64\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\usr\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\bin
    displayName: Work around for recent broken system path on Hosted VS2017 build agents.
    # see ICM https://icm.ad.msft.net/imp/v3/incidents/details/171621867/home
    # see PR  https://github.com/actions/virtual-environments/pull/211/files that broke many bash commands on Hosted VS2017 build agents.
  - bash: ./ci/set-variables.sh
    displayName: Set variables
  - task: DownloadBuildArtifacts@0
    displayName: 'Downloading NuGet package'
    inputs:
      artifactName: Windows
      downloadPath: $(System.ArtifactsDirectory)/In
      itemPattern: '**/*.nupkg'
  - task: NuGetToolInstaller@0
    displayName: Use NuGet $(SPEECHSDK_NUGET_VERSION)
    inputs:
      versionSpec: $(SPEECHSDK_NUGET_VERSION)
  - bash: |
      set -u -e -x -o pipefail
      perl ci/patch-samples-pkg.pl "$(SPEECHSDK_SEMVER2NOMETA)" "$(UwpSampleDir)"
      ./ci/nuget/restore-from-local.sh "$(cygpath -au "$(Build.ArtifactStagingDirectory)/In/Windows")" "$(UwpSampleDir)"
    displayName: 'Patch version and restore packages'
  - powershell: |
      New-Item -ErrorAction Stop -ItemType Directory "$(Build.ArtifactStagingDirectory)/WACK"
      ./ci/Invoke-Wack.ps1 `
        -Solution "$(UwpSampleDir)/helloworld.sln" `
        -CertPath "$(UwpSampleDir)/helloworld/helloworld_TemporaryKey.pfx" `
        -Path "$(Build.ArtifactStagingDirectory)/WACK/appcertreport.xml"
    displayName: Build and run Windows AppCert Kit
  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/WACK'
      ArtifactName: WACK
      publishLocation: Container
    condition: succeededOrFailed()
    displayName: 'Publish WACK report'

- job: RemoteConversationTranscriberJavaBuild
  dependsOn: [Pre, JavaJrePackage]
  condition: and(succeeded('Pre', 'JavaJrePackage'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' RemoteConversationTranscriberJavaBuild '))
  pool:
    name: Hosted Ubuntu 1604
  timeoutInMinutes: 240
  steps:
  - bash: |
      set -e -o pipefail
      . ci/functions.sh
      ./ci/set-variables.sh
    displayName: Set variables
  - bash: |
      set -e -o pipefail
      . ci/functions.sh
      ./ci/set-variables.sh
      RELEASE_SDK_VERSION_FOR_USE="$SPEECHSDK_SEMVER2NOMETA"
      echo $RELEASE_SDK_VERSION_FOR_USE
      RemoteTranscriptionMavenRoot="$(pwd)/source/extensions/remoteconversation/java/maven/maven/com/microsoft/cognitiveservices/speech/remoteconversation/remote-conversation/$RELEASE_SDK_VERSION_FOR_USE/"
      echo $RemoteTranscriptionMavenRoot
      vsts_setvars_by_ref RemoteTranscriptionMavenRoot RELEASE_SDK_VERSION_FOR_USE
    displayName: Set more variables
  - bash: |
      sudo apt-get update
      sudo apt-get install --yes maven
    displayName: Install maven
  - task: DownloadBuildArtifacts@0
    inputs:
      artifactName: JavaJrePackage
      downloadPath: $(System.ArtifactsDirectory)/In
      itemPattern: '**/*.jar'
    displayName: Download client-sdk JavaJrePackage artifacts
  - bash: |
      set -e -o pipefail
      echo "$(System.ArtifactsDirectory)/In/"$SPEECHSDK_MAVEN_ARTIFACT_ID-$SPEECHSDK_SEMVER2NOMETA.jar
      ls -l "$(System.ArtifactsDirectory)/In/JavaJrePackage/maven/com/microsoft/cognitiveservices/speech/"$SPEECHSDK_MAVEN_ARTIFACT_ID/$SPEECHSDK_SEMVER2NOMETA/$SPEECHSDK_MAVEN_ARTIFACT_ID-$SPEECHSDK_SEMVER2NOMETA.jar
      mvn install:install-file -Dfile="$(System.ArtifactsDirectory)/In/JavaJrePackage/maven/com/microsoft/cognitiveservices/speech/"$SPEECHSDK_MAVEN_ARTIFACT_ID/$SPEECHSDK_SEMVER2NOMETA/$SPEECHSDK_MAVEN_ARTIFACT_ID-$SPEECHSDK_SEMVER2NOMETA.jar -DgroupId=com.microsoft.cognitiveservices.speech -DartifactId=$SPEECHSDK_MAVEN_ARTIFACT_ID -Dversion=$SPEECHSDK_SEMVER2NOMETA -Dpackaging=jar -DgeneratePom=true
    displayName: Install client-sdk JavaJrePackage
  - bash: |
      set -e -o pipefail
      cd source/extensions/remoteconversation/java
      sed -i "s/buildVersion1234/$RELEASE_SDK_VERSION_FOR_USE/g" pom.xml
      cat pom.xml
    displayName: Update pom xml file with the client SDK build to be picked
  - bash: |
      set -e -o pipefail
      cd source/extensions/remoteconversation/java
      mvn package
      cp pom.xml target/remote-conversation-$RELEASE_SDK_VERSION_FOR_USE.pom
      ls -l target/
      mkdir -p "$(RemoteTranscriptionMavenRoot)"
      cp target/remote-conversation-$RELEASE_SDK_VERSION_FOR_USE.pom "$(RemoteTranscriptionMavenRoot)"
      cp target/remote-conversation-$RELEASE_SDK_VERSION_FOR_USE.jar "$(RemoteTranscriptionMavenRoot)"
      ls -l "$(RemoteTranscriptionMavenRoot)"
    displayName: Create remote conversation transcription package
  - bash: |
      set -e -o pipefail
      cd "$(RemoteTranscriptionMavenRoot)"
      ls -l
      mvn install:install-file -Dfile=remote-conversation-$RELEASE_SDK_VERSION_FOR_USE.jar -DgroupId=com.microsoft.cognitiveservices.speech.remoteconversation -DartifactId=remote-conversation -Dversion=$RELEASE_SDK_VERSION_FOR_USE -Dpackaging=jar -DgeneratePom=true
      rm -rf ~/.m2/repository/com/microsoft/cognitiveservices/speech/remoteconversation/remote-conversation/$RELEASE_SDK_VERSION_FOR_USE/remote-conversation-$RELEASE_SDK_VERSION_FOR_USE.pom
      cp -rf remote-conversation-$RELEASE_SDK_VERSION_FOR_USE.pom ~/.m2/repository/com/microsoft/cognitiveservices/speech/remoteconversation/remote-conversation/$RELEASE_SDK_VERSION_FOR_USE/remote-conversation-$RELEASE_SDK_VERSION_FOR_USE.pom
    displayName: Install remote conversation transcription package
  - bash: |
      set -e -o pipefail
      export AUDIO_DIR_PATH=$(pwd)/tests/input/audio
            rm -f ./tests/test.subscriptions.regions.json
      cat > ./tests/test.subscriptions.regions.json <<HEREDOC
        $(KEYS_AND_REGIONS)
      HEREDOC
      cp tests/test.defaults.json tests/functional/java
      cp tests/test.audio.utterances.json tests/functional/java
      cp tests/test.subscriptions.regions.json tests/functional/java
      cp -r tests/input tests/functional/java
      cd tests/functional/java
      sed -i "s/buildVersion1234/$RELEASE_SDK_VERSION_FOR_USE/g" pom.xml
      cat pom.xml
      mvn clean test -Dtest=tests.unit.RemoteConversationTranscriptionTest
    displayName: run unit test for remote conversation transcription package
  - task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
    displayName: 'Sign *.jar'
    inputs:
      ConnectedServiceName: 'Speech SDK ESRP Signing Alternate'
      FolderPath: '$(RemoteTranscriptionMavenRoot)'
      Pattern: '*.jar'
      signConfigType: inlineSignParams
      inlineOperation: $(SIGN_PARAMS_JAVA)
    condition: and(succeeded(), eq(variables['SPEECHSDK_SIGN'], 'true'))
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: Remote conversation Jar and pom'
    inputs:
      PathtoPublish: 'source/extensions/remoteconversation/java/maven'
      ArtifactName: RemoteConversationJar
      publishLocation: Container

- job: NuGetOsxTest
  dependsOn: [Pre, NuGet, WindowsBuild]
  condition: and(succeeded('Pre', 'NuGet', 'WindowsBuild'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' NuGetOsxTest '))
  pool:
    name: Hosted macOS
  timeoutInMinutes: 240
  steps:
  - bash: brew config && brew install bash
    displayName: Install modern bash on macOS
  - bash: |
      set -x -e -o pipefail
      . ci/functions.sh
      ./ci/set-variables.sh
    displayName: Set variables
  - task: DownloadBuildArtifacts@0
    displayName: Downloading Windows artifacts
    inputs:
      artifactName: Windows
      downloadPath: $(System.ArtifactsDirectory)/In
      itemPattern: '**/*.nupkg'
  - bash: sudo xcode-select -s /Applications/Xcode_10.3.app/Contents/Developer
    displayName: Select XCode Version 10.3
  - bash: |
      set -u -e -o pipefail
      rm -f ./tests/test.subscriptions.regions.json
      cat > ./tests/test.subscriptions.regions.json <<HEREDOC
        $(KEYS_AND_REGIONS)
      HEREDOC
      mkdir -p "tests/functional/csharp/end2end/bin/Debug/netcoreapp2.0"
      cp tests/test.defaults.json tests/functional/csharp/end2end/bin/Debug/netcoreapp2.0
      cp tests/test.audio.utterances.json tests/functional/csharp/end2end/bin/Debug/netcoreapp2.0
      cp tests/test.subscriptions.regions.json tests/functional/csharp/end2end/bin/Debug/netcoreapp2.0
      cp -r tests/input tests/functional/csharp/end2end/bin/Debug/netcoreapp2.0
      cp tests/test.defaults.json tests/functional/csharp/end2end
      cp tests/test.audio.utterances.json tests/functional/csharp/end2end
      cp tests/test.subscriptions.regions.json tests/functional/csharp/end2end
      cp -r tests/input tests/functional/csharp/end2end
    displayName: Copy subscriptions and regions
  - bash: |
      set -u -e -x -o pipefail
      . ci/functions.sh
      perl ci/patch-samples-pkg.pl "$(SPEECHSDK_SEMVER2NOMETA)" tests/functional/csharp/end2end/
      exitCode=0
      mkdir localnuget
      nugetsource=${PWD}/localnuget
      cp -v "$(System.ArtifactsDirectory)/In/Windows/"Microsoft.CognitiveServices.Speech.*.nupkg localnuget

      cd tests/functional/csharp/end2end
      dotnet restore --no-cache --source https://api.nuget.org/v3/index.json --source ${nugetsource} Microsoft.CognitiveServices.Speech.Tests.EndToEnd.csproj

      # set +e to allow captureing exit codes and retry loop, rather than blindly exiting the bash shell on error.
      set +e

      ACTUAL_LOG_FILE_NAME=test-csharp_osx_unit_tests
      LOG_FILE_NAME=LogFileName=$ACTUAL_LOG_FILE_NAME.trx
      echo $ACTUAL_LOG_FILE_NAME
      echo $LOG_FILE_NAME
      dotnet test --blame --verbosity detailed --filter \
      "TestCategory!=LongTest&TestCategory!=SpeechSynthesisMockTest&ClassName!=Microsoft.CognitiveServices.Speech.Tests.EndToEnd.KwsRecognitionTests&ClassName!=Microsoft.CognitiveServices.Speech.Tests.EndToEnd.KwsRecognizerTests&TestCategory!=CompressedStreamTest&TestCategory!=OfflineUnidec" \
      --framework netcoreapp2.0 --settings csharp.runsettings --logger "trx;$LOG_FILE_NAME"

      exitCode=$?

      ACTUAL_LOG_FILE_NAME_RETRY=$ACTUAL_LOG_FILE_NAME

      for i in $(seq 1 4); do
        if [[ $exitCode != 0 ]]; then
          echo Parsing the trx file "./TestResults/$ACTUAL_LOG_FILE_NAME_RETRY.trx"
          tests=""
          FAILED="outcome=\"Failed\""
          TESTNAME="testName"
          while read p; do
            if [[ "$p" == *"$FAILED"* ]] && [[ "$p" != *parentExecutionId* ]]; then
              words=( $p )
              for q in "${words[@]}"; do
                if [[ "$q" == *"$TESTNAME"* ]] ; then
                  test=${q:10}
                  test="${test::-1}"
                  tests="$tests | (Name=$test)"
                fi
              done
            fi
          done <"./TestResults/$ACTUAL_LOG_FILE_NAME_RETRY.trx"
          tests=${tests:3}

          ACTUAL_LOG_FILE_NAME_RETRY=$ACTUAL_LOG_FILE_NAME-retry$i
          LOG_FILE_NAME_RETRY=LogFileName=$ACTUAL_LOG_FILE_NAME_RETRY.trx

          echo "Rerunning the following failed test "
          echo "${tests[*]}"
          dotnet test --blame --verbosity detailed --filter "$tests" --framework netcoreapp2.0 --settings csharp.runsettings --logger "trx;$LOG_FILE_NAME_RETRY"
          exitCode=$?
        else
          break
        fi
      done
      set -e
      exit ${exitCode}
    displayName: Run C# unit tests
    condition: eq(variables['SPEECHSDK_RUN_TESTS'], 'true')
    continueOnError: ${{ parameters.continueOnTestFailure }}
  - task: PublishTestResults@2
    inputs:
      testRunner: VSTest
      testResultsFiles: '**/test-*.trx'
    condition: and(succeededOrFailed(), eq(variables['SPEECHSDK_RUN_TESTS'], 'true'))

- job: AndroidBuild
  variables:
    ANDROID_NDK: $(System.ArtifactsDirectory)\ndk-r16b
    ANDROID_GST: $(Build.SourcesDirectory)\external\gstreamer-android
  dependsOn: Pre
  condition: and(succeeded('Pre'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' AndroidBuild '))
  pool:
    name: Hosted VS2017
  timeoutInMinutes: 30
  strategy:
    maxParallel: 8
    matrix:
      arm32_debug:
        BuildPlatform: arm32
        GstBuildPlatform: armv7
        GstAbiFilter: armeabi-v7a
        BuildConfiguration: Debug
      arm32_release:
        BuildPlatform: arm32
        GstBuildPlatform: armv7
        GstAbiFilter: armeabi-v7a
        BuildConfiguration: Release
      arm64_debug:
        BuildPlatform: arm64
        GstBuildPlatform: arm64
        GstAbiFilter: arm64-v8a
        BuildConfiguration: Debug
      arm64_release:
        BuildPlatform: arm64
        GstBuildPlatform: arm64
        GstAbiFilter: arm64-v8a
        BuildConfiguration: Release
      x64_debug:
        BuildPlatform: x64
        GstBuildPlatform: x86_64
        GstAbiFilter: x86_64
        BuildConfiguration: Debug
      x64_release:
        BuildPlatform: x64
        GstBuildPlatform: x86_64
        GstAbiFilter: x86_64
        BuildConfiguration: Release
      x86_debug:
        BuildPlatform: x86
        GstBuildPlatform: x86
        GstAbiFilter: x86
        BuildConfiguration: Debug
      x86_release:
        BuildPlatform: x86
        GstBuildPlatform: x86
        GstAbiFilter: x86
        BuildConfiguration: Release
  steps:
  - script: |
      echo ##vso[task.prependpath]C:\Program Files\Git\mingw64\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\usr\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\bin
    displayName: Work around for recent broken system path on Hosted VS2017 build agents.
    # see ICM https://icm.ad.msft.net/imp/v3/incidents/details/171621867/home
    # see PR  https://github.com/actions/virtual-environments/pull/211/files that broke many bash commands on Hosted VS2017 build agents.
  - task: ms-devlabs.utilitytasks.task-Shellpp.Shell++@0
    displayName: Set Android target platform (arm32 or arm64)
    inputs:
      type: InlineScript
      script: |
        . ci/functions.sh
        vsts_setvar SPEECHSDK_TARGET_PLATFORM Android-$(BuildPlatform)
        vsts_setvar SPEECHSDK_BUILD_CONFIGURATION "$(BuildConfiguration)"
        vsts_setvar GST_BUILD_CONFIGURATION "$(ANDROID_GST)\$(GstBuildPlatform)"
        vsts_setvar SPEECHSDK_ENABLE_KWS true
        vsts_setvar EXTENSION_AUDIOCOMPRESSION_ENABLED true
        vsts_setvar SPEECHSDK_ENABLE_CODEC true
  - bash: ./ci/set-variables.sh
    displayName: Set variables
  - bash: ./ci/install-build-dependencies.sh
    displayName: Install build dependencies
  - task: ms-devlabs.utilitytasks.task-Shellpp.Shell++@0
    displayName: Get NDK
    inputs:
      type: InlineScript
      script: |
        set -u -x -e -o pipefail
        . ci/functions.sh
        NDK_VER=r16b
        NDK_SHA1SUM=f3f1909ed1052e98dda2c79d11c22f3da28daf25
        NDK_BASE="$(System.ArtifactsDirectory)\ndk-$NDK_VER"
        NDK_BASE_UNIX="$(cygpath -au "$NDK_BASE")"
        NDK_ZIP="$NDK_BASE_UNIX.zip"
        retry 2 curl --http1.1 -C - https://dl.google.com/android/repository/android-ndk-$NDK_VER-windows-x86_64.zip -o "$NDK_ZIP"
        echo "$NDK_SHA1SUM  $NDK_ZIP" | sha1sum -c --strict -
        unzip -q -o "$NDK_ZIP" -d "$NDK_BASE_UNIX.tmp"
        # A single nested directory should be inside
        existsExactlyOneDir "$NDK_BASE_UNIX.tmp"/*
        mv "$NDK_BASE_UNIX.tmp"/* "$NDK_BASE_UNIX"
        rmdir "$NDK_BASE_UNIX.tmp"
        rm "$NDK_ZIP"
  - template: get-kws-artifact.yml
    parameters:
      enableVariable: SPEECHSDK_ENABLE_KWS
      os: Android
  - bash: |
      set -u -e -o pipefail
      . ci/functions.sh
      IFS=$' \t\n\r' read build_id should_be_empty < external/android-openssl/build_id.txt
      # checks
      [[ -z $should_be_empty ]]
      printf '%d' "$build_id" > /dev/null
      vsts_setvar __getAndroidSslArtifactInternal_BuildId "$build_id"
    displayName: Get Android SSL build ID
  - task: DownloadBuildArtifacts@0
    displayName: Download Android SSL build artifact
    inputs:
      buildType: specific
      project: 'e71f1362-9c7d-488b-99c7-3376db8d3302' # Skyman
      pipeline: 7260 # Yml - Carbon Android Dependencies
      buildVersionToDownload: specific
      buildId: $(__getAndroidSslArtifactInternal_BuildId)
      downloadType: specific
      itemPattern: android-openssl/**
      downloadPath: external
    # TODO only download the one we need
  - bash: |
      set -u -e -o pipefail
      . ci/functions.sh
      IFS=$' \t\n\r' read build_id should_be_empty < external/gstreamer-android/build_id.txt
      # checks
      [[ -z $should_be_empty ]]
      printf '%d' "$build_id" > /dev/null
      vsts_setvar GSTREAMER_ANDROID_PREBUILT_ARTIFACT_BUILD_ID "$build_id"
    displayName: Get Gstreamer Android build ID
  - task: DownloadBuildArtifacts@0
    displayName: Download gstreamer-android
    inputs:
      buildType: specific
      project: 'e71f1362-9c7d-488b-99c7-3376db8d3302'
      pipeline: 9377
      buildVersionToDownload: specific
      buildId: $(GSTREAMER_ANDROID_PREBUILT_ARTIFACT_BUILD_ID)
      downloadType: specific
      itemPattern: |
        gstreamer-android/$(GstBuildPlatform)/**
      downloadPath: external
  - bash: |
      set -u -e -o pipefail
      export PATH=$PATH:$ANDROID_NDK
      export GSTREAMER_ROOT_ANDROID=$ANDROID_GST
      export NDK_PROJECT_PATH=$ANDROID_NDK
      ndk-build.cmd -C ./ci/android/gstreamer "NDK_APPLICATION_MK=Application.mk" APP_ABI=$(GstAbiFilter) NDK_LIBS_OUT=.
      cp ./ci/android/gstreamer/$(GstAbiFilter)/libgstreamer_android.so "$(ANDROID_GST)\$(GstBuildPlatform)"
      mkdir -p "$(cygpath -au "$(Build.ArtifactStagingDirectory)")"/Out/GstLibOnlyForTesting/$(GstAbiFilter)
      cp ./ci/android/gstreamer/$(GstAbiFilter)/libgstreamer_android.so "$(cygpath -au "$(Build.ArtifactStagingDirectory)")"/Out/GstLibOnlyForTesting/$(GstAbiFilter)/
    displayName: Generate gstreamer shared object
  - task: BatchScript@1
    displayName: Build
    inputs:
      filename: 'ci\android\build-android.bat'
  - task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
    displayName: Sign com.microsoft.cognitiveservices.speech.jar
    inputs:
      ConnectedServiceName: 'Speech SDK ESRP Signing Alternate'
      FolderPath: 'build/lib'
      Pattern: com.microsoft.cognitiveservices.speech.jar
      signConfigType: inlineSignParams
      inlineOperation: $(SIGN_PARAMS_JAVA)
    condition: and(succeeded(), eq(variables['SPEECHSDK_SIGN'], 'true'))
  - task: ms-devlabs.utilitytasks.task-Shellpp.Shell++@0
    displayName: 'Create artifact: Android'
    inputs:
      type: FilePath
      scriptPath: './ci/drop/bindrop.sh'
      args: '"" $(BuildConfiguration) $(Build.ArtifactStagingDirectory)/Out/Android-$(BuildPlatform)/$(BuildConfiguration) false $(SPEECHSDK_TARGET_PLATFORM)'
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: Android'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/Out'
      ArtifactName: Android
      publishLocation: Container

- job: AndroidAppcenterTest
  dependsOn: [Pre, AndroidBuild]
  condition: and(succeeded('Pre', 'AndroidBuild'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' AndroidAppcenterTest '))
  pool:
    name: Hosted VS2017
  timeoutInMinutes: 60
  variables:
    SPEECHSDK_TEST_STORAGEACCOUNTNAME: csspeechtestdata
    SPEECHSDK_TEST_CONTAINERNAME: testout-$(System.CollectionId)-$(System.DefinitionId)
    SPEECHSDK_TEST_APPCENTERUPLOAD: https://$(SPEECHSDK_TEST_STORAGEACCOUNTNAME).blob.core.windows.net/$(SPEECHSDK_TEST_CONTAINERNAME)/$(Build.BuildId)/android-appcenter/
    # We use versioned device sets in App Center so we can potentially extend
    # them w/o breaking historical test.
    APPCENTER_DEVICESET_VERSION: 1
  steps:
  - script: |
      echo ##vso[task.prependpath]C:\Program Files\Git\mingw64\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\usr\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\bin
    displayName: Work around for recent broken system path on Hosted VS2017 build agents.
    # see ICM https://icm.ad.msft.net/imp/v3/incidents/details/171621867/home
    # see PR  https://github.com/actions/virtual-environments/pull/211/files that broke many bash commands on Hosted VS2017 build agents.
  - bash: ./ci/set-variables.sh
    displayName: Set variables
  - task: UseNode@1
    inputs:
      version: '10.15.1'
  - script: npm -g i appcenter-cli@1.1.13
    displayName: Install AppCenter CLI
  - task: DownloadBuildArtifacts@0
    displayName: 'Downloading Android artifacts'
    inputs:
      artifactName: Android
      downloadPath: $(System.ArtifactsDirectory)/In
      itemPattern: |
        **/Android-arm32/Release/**/com.microsoft.cognitiveservices.speech.*jar
        **/Android-arm32/Release/**/libMicrosoft.CognitiveServices.Speech.*.so
        **/GstLibOnlyForTesting/armeabi-v7a/libgstreamer_android.so
  - bash: |
      . ci/functions.sh &&
      vsts_setvar SPEECHSDK_SASTOKENEXPIRYUTC $(date -u -d "2 hours" +"%Y-%m-%dT%H:%M:%SZ")
    displayName: 'Define expiry time for SAS token (2 hours ahead)'
  - task: AzureCLI@1
    displayName: Generate SAS token
    inputs:
      azureSubscription: 'Custom Speech Development (3a96ef56-41a9-40a0-b0f3-fb125c2b8798) - RG csspeechsdk-carbon'
      scriptLocation: inlineScript
      inlineScript: |
        @echo off
        setlocal enabledelayedexpansion
        @REM create container if it does not exist
        call az storage container create --name %SPEECHSDK_TEST_CONTAINERNAME% --account-name %SPEECHSDK_TEST_STORAGEACCOUNTNAME% || exit /b 1
        @REM Generate SAS. Note: no echo
        set TOKEN=
        for /f %%i in ('call az storage container generate-sas --name %SPEECHSDK_TEST_CONTAINERNAME% --account-name %SPEECHSDK_TEST_STORAGEACCOUNTNAME% --https-only --expiry %SPEECHSDK_SASTOKENEXPIRYUTC% --permissions dlrw -o tsv') DO set "TOKEN=%%~i"
        if not defined TOKEN echo Error acquiring token.&exit /b 1
        echo ##vso[task.setvariable variable=SPEECHSDK_SASTOKEN;issecret=true]!TOKEN!
        set TOKEN=
  - bash: |
      set -u -e -o pipefail
      rm -rf ./tests/test.subscriptions.regions.json
      cat > ./tests/test.subscriptions.regions.json << HEREDOC
        $(KEYS_AND_REGIONS)
      HEREDOC
    displayName: 'Update subscriptions and regions'
  - bash: |
      set -u -e -o pipefail
      set -x
      cp -f ./ci/jsonsettings.py .
      . ./ci/functions.sh
      FAKE_BUILD=buildfromrelease
      mkdir -p "$FAKE_BUILD"{/bin,/lib}
      DROP_DIR=$(cygpath -au "$(System.ArtifactsDirectory)/In/Android/Android-arm32/Release")
      GST_LIB_DIR=$(cygpath -au "$(System.ArtifactsDirectory)/In/Android/GstLibOnlyForTesting")
      cat > "$FAKE_BUILD/MainActivity.properties" <<HEREDOC
        SampleAudioInput=$( getSetting './tests/test.defaults.json' 'InputDir' )/$( getSetting './tests/test.audio.utterances.json' 'SingleUtteranceEnglish.FilePath' )
        SasToken=$(SPEECHSDK_SASTOKEN)
        SasContainerPrefix=$(SPEECHSDK_TEST_APPCENTERUPLOAD)
      HEREDOC
      cp --preserve "$DROP_DIR/public/lib/com.microsoft.cognitiveservices.speech.jar" "$FAKE_BUILD/lib"
      cp --preserve "$DROP_DIR/private/bin/com.microsoft.cognitiveservices.speech.tests.jar" "$FAKE_BUILD/bin"
      cp --preserve "$DROP_DIR/public/lib/libMicrosoft.CognitiveServices.Speech.core.so" "$FAKE_BUILD/lib"
      cp --preserve "$DROP_DIR/public/lib/libMicrosoft.CognitiveServices.Speech.extension.kws.so" "$FAKE_BUILD/lib"
      cp --preserve "$DROP_DIR/public/lib/libMicrosoft.CognitiveServices.Speech.extension.codec.so" "$FAKE_BUILD/lib"
      cp --preserve "$DROP_DIR/public/lib/libMicrosoft.CognitiveServices.Speech.java.bindings.so" "$FAKE_BUILD/bin"
      cp --preserve "$GST_LIB_DIR/armeabi-v7a/libgstreamer_android.so" "$FAKE_BUILD/lib"
      find "$FAKE_BUILD" -ls
    displayName: 'Prepare (fake) build dir for kicking off AppCenter tests'
  - script: |
      set APPCENTER_USER_ID=Speech-SDK-Test
      set APPCENTER_TOKEN_OPTION=--token $(AppCenterToken)
      @REM TODO allow to override when scheduling builds:
      set APPCENTER_DEVICESET=deviceset-$(SPEECHSDK_BUILD_TYPE):$(APPCENTER_DEVICESET_VERSION)
      call .\tests\appcenter\java-android\run_tests.bat buildfromrelease
      @REM Error level will be reported later.
      echo ##vso[task.setvariable variable=TEST_ERRORLEVEL]%ERRORLEVEL%
      exit /b 0
    displayName: Run tests in App Center
  - script: |
      @REM Note: Ignoring errors
      setlocal enabledelayedexpansion
      @echo Downloading AppCenter test results from "%SPEECHSDK_TEST_APPCENTERUPLOAD%".
      "C:\Program Files (x86)\Microsoft SDKs\Azure\AzCopy\AzCopy.exe" ^
        /Source:%SPEECHSDK_TEST_APPCENTERUPLOAD% ^
        /Dest:appcentertestresults ^
        /SourceSAS:"?!sastoken!" ^
        /S /Y /MT /XO
      dir /s/a/b appcentertestresults
      exit /b 0
    displayName: Download test results from Azure Blob Storage
    env:
      sastoken: $(SPEECHSDK_SASTOKEN)
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: AppCenter Test Log Files.'
    condition: eq(variables['SPEECHSDK_RUN_TESTS'], 'true')
    inputs:
      PathtoPublish: 'appcentertestresults'
      ArtifactName: AppCenterTestLogs
      publishLocation: Container
  # TODO would be nice to know how many logs to expect. But it seems would have to parse appcenter cli output for this.
  - task: PublishTestResults@2
    inputs:
      testResultsFiles: appcentertestresults/**.xml
    condition: eq(variables['SPEECHSDK_RUN_TESTS'], 'true')
    displayName: Publish test results
  # Note: blob storage cleanup is implemented by a separate task (to be implemented).
  - script: |
      @echo off
      if %TEST_ERRORLEVEL% gtr 0 (
        echo AppCenter test run failed earlier, will return an error.
        echo For further details, inspect the task log of the earlier ^"Run tests in App Center^" step,
        echo the test results page of the build in Azure DevOps, or the test run page in App Center.
      )
      exit /b %TEST_ERRORLEVEL%
    displayName: Return test error
    continueOnError: ${{ parameters.continueOnTestFailure }}

- job: AndroidPackage
  dependsOn: [Pre, AndroidBuild]
  condition: and(succeeded('Pre', 'AndroidBuild'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' AndroidPackage '))
  pool:
    name: Hosted VS2017
  timeoutInMinutes: 30
  steps:
  - script: |
      echo ##vso[task.prependpath]C:\Program Files\Git\mingw64\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\usr\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\bin
    displayName: Work around for recent broken system path on Hosted VS2017 build agents.
    # see ICM https://icm.ad.msft.net/imp/v3/incidents/details/171621867/home
    # see PR  https://github.com/actions/virtual-environments/pull/211/files that broke many bash commands on Hosted VS2017 build agents.
  - bash: ./ci/set-variables.sh
    displayName: Set variables
  - bash: |
      set -x -e -o pipefail
      . ci/functions.sh
      PublishArtifactName=Android
      ArtifactOutWindows="$(Build.ArtifactStagingDirectory)/Out/$PublishArtifactName"
      ArtifactOut="$(cygpath -au "$ArtifactOutWindows")"
      MavenRootWindows="$ArtifactOutWindows/maven"
      MavenRoot="$ArtifactOut/maven"
      vsts_setvars_by_ref PublishArtifactName ArtifactOut{,Windows} MavenRoot{,Windows}
    displayName: Set package variables
  - task: DownloadBuildArtifacts@0
    inputs:
      artifactName: Android
      downloadPath: $(System.ArtifactsDirectory)/In
  - bash: |
      ./ci/android/build-aar.sh "$(SPEECHSDK_SEMVER2NOMETA)" "$(SPEECHSDK_VERSION_CODE)" "$(Build.ArtifactStagingDirectory)/In/Android"
    displayName: Build AAR content
  # Note: doc says "The file extension should match the selected archive type." - so we are renaming afterwards
  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: './ci/android/aar'
      includeRootFolder: false
      archiveType: zip
      archiveFile: '$(ArtifactOutWindows)/$(SPEECHSDK_MAVEN_ARTIFACT_ID)-$(SPEECHSDK_SEMVER2NOMETA).zip'
    displayName: 'Create .zip (Release)'
  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: ./ci/android/aar-nomic
      includeRootFolder: false
      archiveType: zip
      archiveFile: '$(ArtifactOutWindows)/$(SPEECHSDK_MAVEN_ARTIFACT_ID)-nomic-$(SPEECHSDK_SEMVER2NOMETA).zip'
    displayName: 'Create nomic .zip (Release)'
  # Just archive the debug version for now
  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: './ci/android/aar-debug'
      includeRootFolder: false
      archiveType: zip
      archiveFile: '$(ArtifactOutWindows)/$(SPEECHSDK_MAVEN_ARTIFACT_ID)-$(SPEECHSDK_SEMVER2NOMETA)-debug.zip'
    displayName: 'Create .zip (Debug)'
  # TODO if we use the .pom for Android and JRE, should change <packaging/> and <description/>
  - bash: |
      set -u -x -e -o pipefail
      # The debug package is just placed into the top-level artifact folder, it won't be published.
      mv "$(ArtifactOut)/$(SPEECHSDK_MAVEN_ARTIFACT_ID)-$(SPEECHSDK_SEMVER2NOMETA)-debug".{zip,aar}
      # For the Relase default and no-microphone packages, create directory hierarchy
      mavenGroupDir="$(MavenRoot)/${SPEECHSDK_MAVEN_GROUP_ID//\./\/}"
      mkdir -p "$mavenGroupDir/$(SPEECHSDK_MAVEN_ARTIFACT_ID)"{,-nomic}"/$(SPEECHSDK_SEMVER2NOMETA)"
      # Then, place the packages and pom into these directories.
      for artifactId in "$(SPEECHSDK_MAVEN_ARTIFACT_ID)"{,-nomic}; do
        destName="$mavenGroupDir/$artifactId/$(SPEECHSDK_SEMVER2NOMETA)/$artifactId"
        mv "$(ArtifactOut)/$artifactId-$(SPEECHSDK_SEMVER2NOMETA).zip" "$destName-$(SPEECHSDK_SEMVER2NOMETA).aar"
        cat >> "$destName-$(SPEECHSDK_SEMVER2NOMETA).pom" <<POM
      <?xml version="1.0" encoding="UTF-8"?>
      <project xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd" xmlns="http://maven.apache.org/POM/4.0.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
        <modelVersion>4.0.0</modelVersion>
        <groupId>$(SPEECHSDK_MAVEN_GROUP_ID)</groupId>
        <artifactId>$artifactId</artifactId>
        <version>$(SPEECHSDK_SEMVER2NOMETA)</version>
        <packaging>aar</packaging>
        <name>Microsoft Cognitive Services Speech SDK for Java</name>
        <description>
          This SDK allows you to use the Microsoft Cognitive Speech Service.
          See https://aka.ms/csspeech for more information.
        </description>
        <licenses>
          <license>
            <name>Microsoft Software License Terms for Microsoft Cognitive Services Speech SDK</name>
            <url>https://aka.ms/csspeech/license201809</url>
          </license>
        </licenses>
      </project>
      POM
      done
    displayName: 'Rename .zip -> .aar, place, and create .pom'
  - task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
    displayName: 'Sign *.aar (Release)'
    inputs:
      ConnectedServiceName: 'Speech SDK ESRP Signing Alternate'
      FolderPath: '$(MavenRootWindows)'
      Pattern: '*.aar'
      signConfigType: inlineSignParams
      inlineOperation: $(SIGN_PARAMS_JAVA)
    condition: and(succeeded(), eq(variables['SPEECHSDK_SIGN'], 'true'))
  - bash: |
      set -e -x -o pipefail
      perl ci/patch-samples-pkg.pl "$(SPEECHSDK_SEMVER2NOMETA)" public_samples
      ./ci/run-gradle.sh public_samples "$(MavenRoot)"
    displayName: Build Gradle-based samples
  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/Out'
      ArtifactName: '$(PublishArtifactName)'
      publishLocation: Container
    displayName: 'Publish'
    condition: succeededOrFailed()

- job: LinuxBuild
  dependsOn: Pre
  condition: and(succeeded('Pre'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' LinuxBuild '))
  pool:
    name: Hosted Ubuntu 1604
  timeoutInMinutes: 240
  strategy:
    maxParallel: 2
    matrix:
      debug:
        BuildConfiguration: Debug
        BuildPlatform: x64
      release:
        BuildConfiguration: Release
        BuildPlatform: x64
  variables:
    OutputDirectory: $(Build.ArtifactStagingDirectory)/Linux-x64/$(BuildConfiguration)
  steps:
  - task: ms-devlabs.utilitytasks.task-Shellpp.Shell++@0
    displayName: Set Linux-x64 target platform
    inputs:
      type: InlineScript
      script: |
        . ci/functions.sh
        vsts_setvar SPEECHSDK_TARGET_PLATFORM Linux-x64
        vsts_setvar SPEECHSDK_BUILD_CONFIGURATION "$(BuildConfiguration)"
        vsts_setvar SPEECHSDK_ENABLE_KWS true
        vsts_setvar SPEECHSDK_ENABLE_CODEC true
        vsts_setvar SPEECHSDK_ENABLE_UNIDEC true
        vsts_setvar VSTS_TOKEN "$(System.AccessToken)"
  - bash: ./ci/set-variables.sh
    displayName: Set variables
  - bash: ./ci/install-build-dependencies.sh
    displayName: Install build dependencies
  - template: get-kws-artifact.yml
    parameters:
      enableVariable: SPEECHSDK_ENABLE_KWS
      os: Linux
  - template: get-unidec-artifact.yml
    parameters:
      enableVariable: SPEECHSDK_ENABLE_UNIDEC
      os: linux
  - bash: sudo ./ci/build-linux-openssl.sh linux-x86_64
    displayName: Build OpenSSL 1.1.1b (target=linux-x86_64)
  - task: ms-devlabs.utilitytasks.task-Shellpp.Shell++@0
    displayName: C API can be parsed by GCC
    inputs:
      type: FilePath
      scriptPath: './ci/check-gcc-parse.sh'
  - bash: |
      rm -f ./tests/test.subscriptions.regions.json
      cat > ./tests/test.subscriptions.regions.json << HEREDOC
        $(KEYS_AND_REGIONS)
      HEREDOC
    displayName: Write Subscriptions Regions Data
  - task: CMake@1
    displayName: Generate makefiles
    inputs:
      cmakeArgs: >-
        -DCMAKE_BUILD_TYPE=$(BuildConfiguration)
        -DSPEECHSDK_TARGET_PLATFORM=$(SPEECHSDK_TARGET_PLATFORM)
        -DSPEECHSDK_BUILD_TYPE=$(SPEECHSDK_BUILD_TYPE)
        -DSPEECHSDK_VERSION=$(SPEECHSDK_SEMVER2NOMETA)
        -DEXTENSION_KWS_ENABLED=$(SPEECHSDK_ENABLE_KWS)
        -DEXTENSION_CODEC_ENABLED="%SPEECHSDK_ENABLE_CODEC%"
        -DEXTENSION_UNIDEC_ENABLED=$(SPEECHSDK_ENABLE_UNIDEC)
        ..
  - task: CMake@1
    displayName: CMake build
    inputs:
      cmakeArgs: '--build . -- -j4'
  - template: build-unix-python-wheels.yml
  - task: ms-devlabs.utilitytasks.task-Shellpp.Shell++@0
    displayName: Create drop files
    inputs:
      type: FilePath
      scriptPath: './ci/drop/bindrop.sh'
      args: '"Linux-x64" $(BuildConfiguration) $(Build.ArtifactStagingDirectory)/Linux-x64/$(BuildConfiguration) false'
  - task: PublishBuildArtifacts@1
    displayName: Publish drop
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: Linux
      publishLocation: Container
  - template: test-during-build.yml
    parameters:
      continueOnTestFailure: ${{ parameters.continueOnTestFailure }}
# this test should only run on the Linux Ubuntu Agent pool, so that the latency data produced is from datcenter "westus" to "westus2".
  - template: run-latency-test.yml
    parameters:
      speechKey: "$(WestUSLatencyTestSpeechKey)"
      region: "westus"

- job: LinuxProxyTest
  dependsOn: [Pre, LinuxBuild]
  condition: and(succeeded('Pre', 'LinuxBuild'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' LinuxProxyTest '))
  pool:
    name: Hosted Ubuntu 1604
  steps:
  - bash: |
      set -e -o pipefail
      . ci/functions.sh
      ./ci/set-variables.sh
    displayName: Set variables
  - task: DownloadBuildArtifacts@0
    displayName: Download Linux binary
    inputs:
      artifactName: Linux
      downloadPath: $(System.ArtifactsDirectory)
  - template: get-docker-image.yml
    parameters:
      imageBase: dev_ubuntu1604_x64
      outvarImage: DOCKER_IMAGES
  - bash: |
      ./ci/build/proxy-test.sh $(System.ArtifactsDirectory)
    continueOnError: ${{ parameters.continueOnTestFailure }}
    displayName: Run the proxy test

- job: macOSProxyTest
  dependsOn: [Pre, macOSProxyBuild, JavaJrePackageMacOSProxy]
  condition: and(succeeded('Pre', 'macOSProxyBuild', 'JavaJrePackageMacOSProxy'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' macOSProxyTest '))
  pool:
    name: Hosted macOS
  variables:
    BuildPlatform: macOSProxy
    BuildConfiguration: Release
  steps:
  - bash: brew config && brew install bash
    displayName: Install modern bash
  - bash: brew install findutils
    displayName: Install findutils for maven script
  - bash: sudo xcode-select -s /Applications/Xcode_10.3.app/Contents/Developer
    displayName: Select XCode Version 10.3
  - bash: |
      set -e -o pipefail
      . ci/functions.sh
      ./ci/set-variables.sh
    displayName: Set variables
  - task: DownloadBuildArtifacts@0
    displayName: Download macOS artefacts (for carbonx)
    inputs:
      artifactName: $(BuildPlatform)
      downloadPath: $(System.ArtifactsDirectory)
      itemPattern: '$(BuildPlatform)/$(BuildConfiguration)/**'
    continueOnError: ${{ parameters.continueOnTestFailure }}
  - task: DownloadBuildArtifacts@0
    displayName: Download Java artefacts
    inputs:
      artifactName: JavaJrePackageMacOSProxy
      downloadPath: $(System.ArtifactsDirectory)
      itemPattern: '**/*.jar'
    continueOnError: ${{ parameters.continueOnTestFailure }}
  - bash: |
      set -x -e -o pipefail
      . ci/functions.sh
      PublishArtifactName=JavaJrePackageMacOSProxy
      ArtifactIn="$(Build.ArtifactStagingDirectory)/$PublishArtifactName"
      MavenRoot="$ArtifactIn/maven"
      JarName="$(SPEECHSDK_MAVEN_ARTIFACT_ID)-$(SPEECHSDK_SEMVER2NOMETA).jar"
      relativeMavenPackageDir="${SPEECHSDK_MAVEN_GROUP_ID//\./\/}/$SPEECHSDK_MAVEN_ARTIFACT_ID/$SPEECHSDK_SEMVER2NOMETA"
      PathToJar="$MavenRoot/$relativeMavenPackageDir/$JarName"
      vsts_setvars_by_ref PublishArtifactName ArtifactIn MavenRoot JarName PathToJar
    displayName: Set Java package variables
    continueOnError: ${{ parameters.continueOnTestFailure }}
  - bash: |
      rm -f ./tests/test.subscriptions.regions.json
      cp ./tests/test.defaults.json ./
      cp ./tests/test.audio.utterances.json ./
      cat > ./tests/test.subscriptions.regions.json <<HEREDOC
        $(KEYS_AND_REGIONS)
      HEREDOC
      cp ./tests/test.subscriptions.regions.json ./
      cp -rf ./tests/input .
    displayName: Write Subscriptions Regions Data
  - bash: |
      set -u -e -o pipefail
      . ci/functions.sh
      cp ./ci/jsonsettings.py .
      perl ci/patch-samples-pkg.pl "$(SPEECHSDK_SEMVER2NOMETA)" public_samples
          patchSample public_samples/quickstart/java/jre/from-microphone
          patchSample public_samples/quickstart/java/jre/text-to-speech
          patchSample public_samples/quickstart/java/jre/translate-speech-to-text
          patchSample public_samples/quickstart/java/jre/virtual-assistant
          patchSample public_samples/samples/java/jre/console
    displayName: Patch Java quickstart
    continueOnError: ${{ parameters.continueOnTestFailure }}
  - bash: |
      ./ci/build/osx-proxy-test.sh $(System.ArtifactsDirectory) $(PathToJar)
    displayName: Run proxy tests
    continueOnError: ${{ parameters.continueOnTestFailure }}

- template: linux-docker-build.yml
  parameters:
    continueOnTestFailure: ${{ parameters.continueOnTestFailure }}
    buildType: ${{ parameters.buildType }}

- template: nuget-linux-test.yml
  parameters:
    continueOnTestFailure: ${{ parameters.continueOnTestFailure }}
    buildType: ${{ parameters.buildType }}

- job: LinuxPythonOobeTest
  dependsOn: [Pre, LinuxBuild]
  condition: and(succeeded('Pre', 'LinuxBuild'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' LinuxPythonOobeTest '))
  pool:
    name: Hosted Ubuntu 1604
  timeoutInMinutes: 70
  steps:
  - bash: |
      set -x -e -o pipefail
      . ci/functions.sh
      ./ci/set-variables.sh
    displayName: Set variables
  - task: DownloadBuildArtifacts@0
    displayName: Downloading Python artifacts
    inputs:
      artifactName: Linux
      downloadPath: $(System.ArtifactsDirectory)/In
      itemPattern: '**/*linux*_x86_64.whl'
  - template: get-docker-image.yml
    parameters:
      imageBase: oobedevpy35_ubuntu1604_x64 oobedevpy36_ubuntu1804_x64 oobedevpy35_debian9_x64 oobedevpy37_debian9py37_x64 oobedevpy36_centos7_x64 oobedevpy36_centos8_x64
      outvarImage: DOCKER_IMAGES
  - bash: |
      rm -f ./tests/test.subscriptions.regions.json
      cp ./tests/test.defaults.json ./
      cp ./tests/test.audio.utterances.json ./
      cat > ./tests/test.subscriptions.regions.json <<HEREDOC
        $(KEYS_AND_REGIONS)
      HEREDOC
      cp ./tests/test.subscriptions.regions.json ./
      cp -rf ./tests/input .
    displayName: Write Subscriptions Regions Data
  - bash: |
      set -u -e -x -o pipefail
      . ci/functions.sh
      cp --recursive --verbose $(System.ArtifactsDirectory)/In/Linux/Linux-x64/Release/wheelhouse wheelhouse
      cp ./ci/jsonsettings.py .
      patchSample public_samples/quickstart/python/from-microphone
      patchSample public_samples/quickstart/python/text-to-speech
      patchSample public_samples/samples/python/console
      ERRORS=0
      for i in $(DOCKER_IMAGES); do
        # Python 3.7 wheel is not produced in dev builds.
        ! [[ $SPEECHSDK_BUILD_TYPE = dev && $i = *py37* ]] || continue

        ./ci/samples/test-quickstart-python.sh "$i" wheelhouse ||
          { ((++ERRORS)); vsts_logissue error "Running quickstart/python for image $i failed."; }
      done
    displayName: Test quick starts

- job: BuildPythonDocs
  dependsOn: [Pre, LinuxBuild]
  condition: and(succeeded('Pre', 'LinuxBuild'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' BuildPythonDocs '))
  pool:
    name: Hosted Ubuntu 1604
  timeoutInMinutes: 30
  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: 3.6
      addToPath: true
      architecture: x64
  - bash: |
      set -x -e -o pipefail
      . ci/functions.sh
      ./ci/set-variables.sh
    displayName: Set variables
  - task: DownloadBuildArtifacts@0
    displayName: Downloading Python artifacts
    inputs:
      artifactName: Linux
      downloadPath: $(System.ArtifactsDirectory)/In
      itemPattern: '**/*linux*_x86_64.whl'
  - bash: |
      set -u -e -x -o pipefail
      . ci/functions.sh
      cp --recursive --verbose $(System.ArtifactsDirectory)/In/Linux/Linux-x64/Release/wheelhouse wheelhouse
      #
      VIRTUALENV=pythondocs
      VIRTUALENV_BINDIR=${PWD}/${VIRTUALENV}/bin
      python -m pip install --upgrade pip &&
      pip install virtualenv==16.1.0 &&
      virtualenv -p python3 ${VIRTUALENV}
      MAJORMINOR=$("${VIRTUALENV_BINDIR}"/python -c "import sys; print('%s%s' % (sys.version_info[0:2]))")
      "$VIRTUALENV_BINDIR/pip" install wheelhouse/azure_cognitiveservices_speech-*-cp$MAJORMINOR-*linux*_x86_64.whl
      #
      PACKAGE_DIR=$(echo ${PWD}/${VIRTUALENV}/lib/python3.*/site-packages)
      cp --recursive --verbose source/bindings/python/doc "$PACKAGE_DIR"
      #
      "$VIRTUALENV_BINDIR"/pip install sphinx==1.8.2
      #
      cd "$PACKAGE_DIR"/azure
      "$VIRTUALENV_BINDIR"/sphinx-apidoc --module-first --implicit-namespaces --separate --output-dir ../doc . \
          "${PWD}"/cognitiveservices/speech/speech_py_impl.py \
          "${PWD}"/cognitiveservices/speech/speech.py \
          "${PWD}"/cognitiveservices/speech/version.py
      #
      cd "$PACKAGE_DIR"/doc
      "$VIRTUALENV_BINDIR"/sphinx-build . ../build/ -n -W
      mkdir -p $(Build.ArtifactStagingDirectory)/PythonDocs
      cp --recursive ../doc ../build $(Build.ArtifactStagingDirectory)/PythonDocs
      #
      ERROR=0
      if grep ':[a-z][a-z]*:' ../build/*.html; then
        echo "Unrendered restructured text markup leaked into the documentation. Please check."
        ((ERROR++))
      fi
      #
      if grep -i 'todo|bugbug' ../build/*.html; then
        echo "Unwanted markup leaked into the documentation. Please check."
        ((ERROR++))
      fi
      #
      ((ERROR == 0)) || {
        echo Error\(s\) occurred, stopping.
        false
      }
    displayName: Build python docs
  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: $(Build.ArtifactStagingDirectory)/PythonDocs
      ArtifactName: PythonDocs
      publishLocation: Container

- job: LinuxDrop
  dependsOn: [Pre, LinuxBuild, LinuxDockerBuild]
  condition: and(succeeded('Pre', 'LinuxBuild', 'LinuxDockerBuild'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' LinuxDrop '))
  pool:
    name: Hosted Ubuntu 1604
  timeoutInMinutes: 150
  steps:
  - bash: |
      set -x -e -o pipefail
      . ci/functions.sh
      ./ci/set-variables.sh
    displayName: Set variables
  - task: DownloadBuildArtifacts@0
    displayName: Download Build Artifacts
    inputs:
      artifactName: Linux
  - bash: |
      ./ci/drop/linux-reldrop.sh "$(SPEECHSDK_SEMVER2NOMETA)" "$(Build.Repository.LocalPath)" "$(System.ArtifactsDirectory)/Linux" "$(Build.ArtifactStagingDirectory)/Linux/Drop"
    displayName: Create release drop
  - template: get-docker-image.yml
    parameters:
      #  oobedevcpp_ubuntu1604_x64 oobedevcpp_ubuntu1604_x86 TODO: THERE'S A PROBLEM WITH THESE 2 IMAGES THEY ARE FAILING THE SAMPLE TESTS
      imageBase: oobedevcpp_ubuntu1804_x64 oobedevcpp_ubuntu1804_x86 oobedevcpp_debian9_x64 oobedevcpp_debian9_x86 oobedevcpp_centos7_x64 oobedevcpp_centos8_x64
      outvarImage: DOCKER_IMAGES
  - bash: |
      rm -f ./tests/test.subscriptions.regions.json
      cp ./tests/test.defaults.json ./
      cp ./tests/test.audio.utterances.json ./
      cat > ./tests/test.subscriptions.regions.json <<HEREDOC
        $(KEYS_AND_REGIONS)
      HEREDOC
      cp ./tests/test.subscriptions.regions.json ./
      cp -rf ./tests/input .
    displayName: Write Subscriptions Regions Data  
  - bash: |
      cp ./ci/jsonsettings.py .
      . ci/functions.sh &&
      patchSample public_samples/quickstart/cpp/linux
      patchSample public_samples/samples/cpp/windows/console
    displayName: Patch quickstart
  - bash: |
      set -x -u -e -o pipefail
      . ci/functions.sh
      ERRORS=0

      # Prepare binaries / libraries from the drop as the test would expect it.
      for architecture in x86 x64; do
        bindir=buildfromdrop$architecture/bin
        mkdir -p $bindir
        cp --verbose "$(System.ArtifactsDirectory)/Linux/Linux-$architecture/Release/"{public/lib,private/{bin,lib}}/* $bindir
        chmod 755 $bindir/*
      done

      mkdir speechsdk # will fail if existing
      tar -xzf "$(Build.ArtifactStagingDirectory)/Linux/Drop/SpeechSDK-Linux-$(SPEECHSDK_SEMVER2NOMETA).tar.gz" --strip-components=1 -C speechsdk

      for i in $(DOCKER_IMAGES); do
        [[ $i =~ _([^_]*): ]] || exitWithError "Cannot parse out architecture from %s" "$i"
        architecture="${BASH_REMATCH[1]}"

        # Run samples
        ./ci/samples/test-quickstart-cpp-linux.sh "$i" speechsdk "$architecture" || {
          vsts_logissue error "Running quickstart/cpp-linux for image $i failed."
          ((++ERRORS))
        }

        # Skip other samples on non-Ubuntu 16.04 in dev builds
        [[ $SPEECHSDK_BUILD_TYPE = dev && $i != *_ubuntu1604_* ]] ||
          ./ci/samples/test-samples-cpp-console.sh "$i" speechsdk "$architecture" || {
            vsts_logissue error "Running samples/cpp/windows/console sample for image $i failed."
            ((++ERRORS))
          }

        # Run unit tests (skip non-Ubuntu 16.04 in dev builds)
        #[[ $SPEECHSDK_BUILD_TYPE = dev && $i != *_ubuntu1604_* ]] ||
        #  docker run --rm --env LD_LIBRARY_PATH=/csspeech/buildfromdrop$architecture/bin --workdir /csspeech --volume "$PWD:/csspeech" "$i" ./ci/run-tests.sh \
        #    --build-dir buildfromdrop$architecture \
        #    --platform Linux-$architecture-Release \
        #    -D long-running=false -- cxx_core_tests cxx_api_tests ||
        #    {
        #      vsts_logissue error "Running tests for image $i failed."
        #      ((++ERRORS))
        #    }

        docker run --rm --env LD_LIBRARY_PATH=/csspeech/buildfromdrop$architecture/bin --workdir /csspeech --volume "$PWD:/csspeech" "$i" bash - <<"HERE_DOC"
          set -e -o pipefail
          ./ci/run-tests.sh \
              --build-dir buildfromdrop$architecture \
              --platform Linux-$architecture-Release \
              -D long-running=false -- cxx_core_tests cxx_api_tests ||
              {
                vsts_logissue error "Running tests for image $i failed."
                ((++ERRORS))
              }
      HERE_DOC
      done
      [[ $ERRORS == 0 ]] || exitWithError "Not all tests/samples ran successfully."
    displayName: Build and test quickstarts
    condition: eq(variables['SPEECHSDK_RUN_TESTS'], 'true')
    continueOnError: ${{ parameters.continueOnTestFailure }}
    timeoutInMinutes: 120
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: Linux Release Drop'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/Linux'
      ArtifactName: Linux
      publishLocation: Container
    condition: succeeded()

- job: IosBuild
  dependsOn: Pre
  condition: and(succeeded('Pre'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' IosBuild '))
  pool:
    name: Hosted macOS
  timeoutInMinutes: 90
  strategy:
    maxParallel: 2
    matrix:
      debug:
        BuildConfiguration: Debug
      release:
        BuildConfiguration: Release
  variables:
    BuildPlatform: iOS
    FrameworkName: MicrosoftCognitiveServicesSpeech
    StaticLibraryName: libMicrosoft.CognitiveServices.Speech.core
    GStreamerWrapper: GStreamerWrapper
    GStreamerVersion: 1.16.0
    VersionedFrameworkName: $(FrameworkName)-$(BuildPlatform)-$(SPEECHSDK_SEMVER2NOMETA)
    OutputDirectory: $(Build.ArtifactStagingDirectory)/$(BuildPlatform)/$(BuildConfiguration)
    JointCmakeArgs: -DCMAKE_BUILD_TYPE=$(BuildConfiguration) -DSPEECHSDK_BUILD_TYPE=$(SPEECHSDK_BUILD_TYPE) -DSPEECHSDK_VERSION=$(SPEECHSDK_SEMVER2NOMETA) -DCMAKE_FRAMEWORK_PATH="$(OutputDirectory);${HOME}/Library/Developer/GStreamer/iPhone.sdk/"
  steps:
  # Update bash really early so it will be picked up by "bash" steps.
  - bash: brew config && brew install bash coreutils
    displayName: Install modern bash and coreutils
  - bash: sudo xcode-select -s /Applications/Xcode_10.3.app/Contents/Developer
    displayName: Select XCode Version 10.3
  - bash: |
      xcodebuild -version
    displayName: 'Log Xcode version'
  - bash: |
      . ci/functions.sh &&
      vsts_setvar SPEECHSDK_TARGET_PLATFORM $(BuildPlatform)-x64 &&
      vsts_setvar SPEECHSDK_BUILD_CONFIGURATION "$(BuildConfiguration)"
      vsts_setvar SPEECHSDK_ENABLE_CODEC true
      vsts_setvar SPEECHSDK_ENABLE_KWS true
    displayName: Set iOS target platform
  - bash: ./ci/set-variables.sh
    displayName: Set variables
  - template: get-kws-artifact.yml
    parameters:
      enableVariable: SPEECHSDK_ENABLE_KWS
      os: iOS
  - task: DownloadBuildArtifacts@0
    displayName: Download GStreamer artifact
    inputs:
      buildType: specific
      project: 'e71f1362-9c7d-488b-99c7-3376db8d3302' # Skyman
      pipeline: 9377 # Yml - Carbon Download and Extract
      buildVersionToDownload: specific
      buildId: 6045491
      artifactName: GStreamer-iOS
  - bash: |
      # set up the GStreamer framework in the same location as the system install
      set -u -e -o pipefail -x
      cd $(Build.ArtifactStagingDirectory)/GStreamer-iOS
      pkgutil --expand  gstreamer-1.0-devel-$(GStreamerVersion)-ios-universal.pkg ./gstreamer
      cd gstreamer/ios-framework-$(GStreamerVersion)-universal.pkg
      tar xf Payload
      mkdir -p ~/Library/Developer/GStreamer/iPhone.sdk
      mv ./GStreamer.framework ~/Library/Developer/GStreamer/iPhone.sdk/
      # this link is missing for deployment to device/simulator
      cd ~/Library/Developer/GStreamer/iPhone.sdk/GStreamer.framework
      ln -s Resources/Info.plist .
    displayName: Unpack GStreamer framework
  - bash: |
      set -u -e -o pipefail -x
      if [[ $(SPEECHSDK_ENABLE_CODEC) == true ]]; then
        mkdir -p build_wrapper
        xcrun xcodebuild build -project public_samples/samples/objective-c/ios/compressed-streams/$(GStreamerWrapper)/$(GStreamerWrapper).xcodeproj -scheme $(GStreamerWrapper) \
          CONFIGURATION_BUILD_DIR=${PWD}/build_wrapper
        # copy to framework search path
        cp -R ${PWD}/build_wrapper/$(GStreamerWrapper).framework ${HOME}/Library/Developer/GStreamer/iPhone.sdk/
        # copy to output directory, for tests
        mkdir -p $(OutputDirectory)
        cp -R ${PWD}/build_wrapper/$(GStreamerWrapper).framework $(OutputDirectory)
      fi
    displayName: Build GStreamer wrapper
  - bash: |
      mkdir build_ios_simulator64 && cd build_ios_simulator64 &&
      cmake $(JointCmakeArgs) -DSPEECHSDK_TARGET_PLATFORM=IOSSIMULATOR-x64 -DEXTENSION_CODEC_ENABLED="$(SPEECHSDK_ENABLE_CODEC)" -DEXTENSION_KWS_ENABLED="$(SPEECHSDK_ENABLE_KWS)" ..
    displayName: Generate makefiles for iOS simulator (64bit)
  - bash: |
      cd build_ios_simulator64 &&
      cmake --build . -- -j4
    displayName: CMake build for iOS simulator (64bit)
  - bash: |
      mkdir build_ios_device && cd build_ios_device &&
      cmake $(JointCmakeArgs) -DSPEECHSDK_TARGET_PLATFORM=IOS-all -DEXTENSION_CODEC_ENABLED="$(SPEECHSDK_ENABLE_CODEC)" -DEXTENSION_KWS_ENABLED="$(SPEECHSDK_ENABLE_KWS)" ..
    displayName: Generate makefiles for iOS device
  - bash: |
      cd build_ios_device &&
      cmake --build . -- -j4
    displayName: CMake build for iOS device
  - bash: |
      set -u -e -o pipefail -x
      . ci/apple/apple-functions.sh
      # create output framework directory
      mkdir -p $(OutputDirectory)
      cp -R "build_ios_device/lib/$(FrameworkName).framework" "$(OutputDirectory)"
      lipo -create -output "$(OutputDirectory)"/$(FrameworkName).framework/$(FrameworkName) \
        "build_ios_"{device,simulator64}"/lib/$(FrameworkName).framework/$(FrameworkName)"

      if [[ $(SPEECHSDK_ENABLE_KWS) == true ]]; then
        cp $(Build.SourcesDirectory)/external/KWS/iOS_arm64_Release/targets/CortanaSDK/libkwsapi.a "build_ios_device/lib"
        cp $(Build.SourcesDirectory)/external/KWS/iOS_x64_Release/targets/CortanaSDK/libkwsapi.a "build_ios_simulator64/lib"
      fi

      # create output static library with bitcode stripped out.
      link_ios_static_library "$(OutputDirectory)" "build_ios_device/lib" "$(StaticLibraryName)_device.a"
      link_ios_static_library "$(OutputDirectory)" "build_ios_simulator64/lib" "$(StaticLibraryName)_sim64.a"
      lipo -create -output "$(OutputDirectory)"/$(StaticLibraryName).bitcode.a \
        $(OutputDirectory)/$(StaticLibraryName)_device.a $(OutputDirectory)/$(StaticLibraryName)_sim64.a
      bitcode_strip_path=`xcrun -sdk iphoneos --find bitcode_strip`
      echo $bitcode_strip_path
      eval $bitcode_strip_path $(OutputDirectory)"/$(StaticLibraryName).bitcode.a -r -o $(OutputDirectory)"/$(StaticLibraryName).a
    displayName: Create universal framework
  - bash: |
      set -u -e -o pipefail -x
      . ci/apple/apple-functions.sh
      combine_dsym_bundles "$(OutputDirectory)" "build_ios_"{device,simulator64}"/lib/$(FrameworkName).framework/$(FrameworkName)"
    condition: and(succeeded(), in(variables['BuildConfiguration'], 'Debug', 'Release'))
    displayName: Create debug symbols
  - bash: |
      set -u -e -o pipefail -x
      cd "$(OutputDirectory)"
      for lib in *.dSYM; do
        zip --symlinks -r "${lib}.zip" "${lib}"
        rm -rf ${lib}
      done
    condition: and(succeeded(), in(variables['BuildConfiguration'], 'Debug', 'Release'))
    displayName: Archive debug symbols
  - bash: |
      strip -x "$(OutputDirectory)/$(FrameworkName).framework/$(FrameworkName)"
      strip -x "$(OutputDirectory)/$(StaticLibraryName).a"
    displayName: Strip dynamic and static libraries in universal framework for release builds
    condition: and(succeeded(), eq(variables['BuildConfiguration'], 'Release'))
  - bash: |
      set -u -e -x -o pipefail
      codesign --force --sign - --deep --timestamp=none "$(OutputDirectory)/$(FrameworkName).framework"
      codesign --deep --display --verbose=4 "$(OutputDirectory)/$(FrameworkName).framework"
      codesign --display --verbose=4 "$(OutputDirectory)/$(FrameworkName).framework/$(FrameworkName)"
      if [[ $(SPEECHSDK_ENABLE_CODEC) == true ]]; then
        codesign --force --sign - --deep --timestamp=none "$(OutputDirectory)/$(GStreamerWrapper).framework/$(GStreamerWrapper)"
        codesign --display --verbose=4  "$(OutputDirectory)/$(GStreamerWrapper).framework/$(GStreamerWrapper)"
      fi
    displayName: 'Self-Sign iOS framework'
    condition: and(succeeded(), eq(variables['SPEECHSDK_SIGN'], 'false'))
  - bash: |
      set -u -e -o pipefail -x
      cp -p "$(Build.Repository.LocalPath)/"{REDIST.txt,license.md,ThirdPartyNotices.md} "$(OutputDirectory)"
      cd "$(OutputDirectory)"
      zip --symlinks -r "$(VersionedFrameworkName).zip" REDIST.txt license.md ThirdPartyNotices.md "$(FrameworkName).framework"
      rm -rf REDIST.txt license.md ThirdPartyNotices.md "$(FrameworkName).framework"
    displayName: Create archive for signing
  - task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
    displayName: 'Sign iOS framework'
    inputs:
      ConnectedServiceName: 'Speech SDK ESRP Signing Alternate'
      FolderPath: '$(OutputDirectory)'
      Pattern: $(VersionedFrameworkName).zip
      signConfigType: inlineSignParams
      inlineOperation: $(SIGN_PARAMS_IOS)
    condition: and(succeeded(), eq(variables['SPEECHSDK_SIGN'], 'true'))
  - bash: |
      ci/apple/unpack_signed_archive.sh "$(OutputDirectory)" $(FrameworkName) $(VersionedFrameworkName) $(Build.Repository.LocalPath)
    condition: and(succeeded(), eq(variables['SPEECHSDK_SIGN'], 'true'))
    displayName: Package signed framework
  - bash: |
      set -u -e -o pipefail
      cd "$(OutputDirectory)"
      zip --symlinks -r "$(GStreamerWrapper).zip" "$(GStreamerWrapper).framework"
      rm -rf "$(GStreamerWrapper).framework"
    displayName: Archive Gstreamer wrapper (for tests)
    condition: and(succeeded(), eq(variables['SPEECHSDK_ENABLE_CODEC'], 'true'))
  - task: PublishBuildArtifacts@1
    displayName: Publish drop
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/$(BuildPlatform)'
      ArtifactName: "$(BuildPlatform)"
      publishLocation: Container
    condition: succeededOrFailed()

- job: IosMultiPlatformTests
  dependsOn: [Pre, IosBuild]
  condition: and(eq(variables['SPEECHSDK_RUN_TESTS'], 'true'), succeeded(), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' IosMultiPlatformTests '))
  pool:
    name: Hosted macOS
  timeoutInMinutes: 60
  strategy:
    maxParallel: 2
  variables:
    FrameworkName: MicrosoftCognitiveServicesSpeech
    BuildPlatform: iOS
    BuildConfiguration: Release
    OutputDirectory: $(Build.ArtifactStagingDirectory)/$(BuildPlatform)/Out/$(BuildConfiguration)
    microsoftDevTeamId: UBF8T346G9
  steps:
  # Update bash really early so it will be picked up by "bash" steps.
  - bash: brew config && brew install bash coreutils
    displayName: Install modern bash and coreutils
  - bash: ./ci/set-variables.sh
    displayName: Set variables
  - task: DownloadBuildArtifacts@0
    displayName: 'Download iOS Build Artifacts'
    inputs:
      artifactName: iOS
      itemPattern: '**/*.zip'
  - bash: sudo xcode-select -s /Applications/Xcode_10.3.app/Contents/Developer
    displayName: Select XCode Version 10.3
  - bash: |
      xcodebuild -version
    displayName: 'Log Xcode version'
  - bash: |
      set -u -e -o pipefail
      . ci/functions.sh
      mkdir xcode-build-output
      cd xcode-build-output
      cp -R $(Build.ArtifactStagingDirectory)/$(BuildPlatform)/$(BuildConfiguration)/*.zip .
      for f in *.zip; do unzip $f; done
    displayName: "Unpack build artifacts"
  - bash: |
      set -e -o pipefail -x
      mkdir -p "$(OutputDirectory)/logs"
      # run the tests
      ci/apple/multiplatformtests.sh tests/functional/objective-c/ios/SpeechSDK_iOS.xcodeproj \
        SpeechSDK_iOS SpeechSDK_iOS $(OutputDirectory)/logs unittests $(microsoftDevTeamId)
    displayName: "Run iOS unit tests"
    condition: eq(variables['SPEECHSDK_RUN_TESTS'], 'true')
    continueOnError: true
  - bash: |
      rm -f ./tests/test.subscriptions.regions.json
      cp ./tests/test.defaults.json ./
      cp ./tests/test.audio.utterances.json ./
      cat > ./tests/test.subscriptions.regions.json <<HEREDOC
        $(KEYS_AND_REGIONS)
      HEREDOC
      cp ./tests/test.subscriptions.regions.json ./
      cp -rf ./tests/input .
    displayName: Write Subscriptions Regions Data  
  - bash: |
      set -u -e -o pipefail -x
      mkdir -p "$(OutputDirectory)/logs"
      . ci/functions.sh
      # set up framework in the correct position - the Xcode project expects the framework here
      ln -s '$(Build.Repository.LocalPath)/xcode-build-output/$(FrameworkName).framework' public_samples/quickstart/objectivec/ios/from-microphone
      # fix the keys
      cp ./ci/jsonsettings.py .
      patchSample public_samples/quickstart/objectivec/ios/from-microphone/helloworld/helloworld
      # run the tests
      ci/apple/multiplatformtests.sh public_samples/quickstart/objectivec/ios/from-microphone/helloworld/helloworld.xcodeproj \
        helloworldUITests helloworldUITests-Runner $(OutputDirectory)/logs quickstart $(microsoftDevTeamId) --usegui
    continueOnError: true
    condition: eq(variables['SPEECHSDK_RUN_TESTS'], 'true')
    displayName: "Run iOS UI test for quickstart"
  - bash: |
      set -u -e -o pipefail -x
      mkdir -p "$(OutputDirectory)/logs"
      . ci/functions.sh
      PROJECT_DIR=public_samples/quickstart/objectivec/ios/text-to-speech/helloworld/
      sed -i '' "s/'~> 1.[[:digit:]]'/path: \"{{{PODSPEC_PATH}}}\"/" ${PROJECT_DIR}/Podfile
      ci/apple/prepare-pods-for-swift-test.sh ${PROJECT_DIR} "$(Build.Repository.LocalPath)/xcode-build-output"
      # fix the keys
      cp ./ci/jsonsettings.py .
      patchSample public_samples/quickstart/objectivec/ios/text-to-speech/helloworld/helloworld
      # run the tests
      ci/apple/multiplatformtests.sh public_samples/quickstart/objectivec/ios/text-to-speech/helloworld/helloworld.xcworkspace \
        helloworldUITests helloworldUITests-Runner $(OutputDirectory)/logs quickstart-tts $(microsoftDevTeamId) --usegui
    continueOnError: true
    condition: eq(variables['SPEECHSDK_RUN_TESTS'], 'true')
    displayName: "Run iOS UI test for TTS quickstart"
  - bash: |
      set -u -e -o pipefail -x
      mkdir -p "$(OutputDirectory)/logs"
      . ci/functions.sh
      # set up framework in the correct position - the Xcode project expects the framework here
      ln -s '$(Build.Repository.LocalPath)/xcode-build-output/$(FrameworkName).framework' public_samples/samples/objective-c/ios/
      # fix the keys
      cp ./ci/jsonsettings.py .
      patchSample public_samples/samples/objective-c/ios/speech-samples/speech-samples
      # run the tests
      ci/apple/multiplatformtests.sh public_samples/samples/objective-c/ios/speech-samples/speech-samples.xcodeproj \
        speech-samplesUITests speech-samplesUITests-Runner $(OutputDirectory)/logs speech-samples $(microsoftDevTeamId) --usegui
    continueOnError: true
    condition: eq(variables['SPEECHSDK_RUN_TESTS'], 'true')
    displayName: "Run iOS UI test for extended samples"
  - bash: |
      set -u -e -o pipefail -x
      mkdir -p "$(OutputDirectory)/logs"
      . ci/functions.sh
      # fix the keys
      cp ./ci/jsonsettings.py .
      patchSample public_samples/samples/objective-c/ios/synthesis-samples/synthesis-samples
      # run the tests
      ci/apple/multiplatformtests.sh public_samples/samples/objective-c/ios/synthesis-samples/synthesis-samples.xcodeproj \
        synthesis-samplesUITests synthesis-samplesUITests-Runner $(OutputDirectory)/logs synthesis-samples $(microsoftDevTeamId) --usegui
    continueOnError: true
    condition: eq(variables['SPEECHSDK_RUN_TESTS'], 'true')
    displayName: "Run iOS UI test for extended TTS samples"
  - task: PublishTestResults@2
    inputs:
      testResultsFiles: '**/test-*.xml'
    condition: eq(variables['SPEECHSDK_RUN_TESTS'], 'true')
    displayName: Publish test results
  - task: PublishBuildArtifacts@1
    displayName: Publish drop
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/$(BuildPlatform)/Out'
      ArtifactName: "$(BuildPlatform)"
      publishLocation: Container
    condition: succeededOrFailed()

- template: macosbuild.yml
  parameters:
    jobName: "macOSBuild"
    buildPlatform: macOS
    continueOnTestFailure: ${{ parameters.continueOnTestFailure }}

- template: macosbuild.yml
  parameters:
    continueOnTestFailure: ${{ parameters.continueOnTestFailure }}
    jobName: "macOSProxyBuild"
    buildPlatform: macOSProxy
    extraDependencyInstallSteps: []
    extraCmakeArgs: "-Duse_openssl=ON -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl"

- template: objectivec-unit-tests.yml
  parameters:
    continueOnTestFailure: ${{ parameters.continueOnTestFailure }}
    jobName: "macOSUnitTests"
    jobDependsOn:
      - Pre
      - macOSBuild
    buildPlatform: macOS
    extraSteps:
      - bash: |
          set -u -x -e -o pipefail
          cd public_samples/quickstart/cpp/macos/from-microphone
          make SPEECHSDK_ROOT='$(Build.Repository.LocalPath)/xcode-build-output'
          [[ -f helloworld ]]
        displayName: "Build STT C++ quickstart"
        condition: succeededOrFailed()
      - bash: |
          set -u -x -e -o pipefail
          cd public_samples/quickstart/cpp/macos/text-to-speech
          make SPEECHSDK_ROOT='$(Build.Repository.LocalPath)/xcode-build-output'
          [[ -f helloworld ]]
        displayName: "Build TTS C++ quickstart"
        condition: succeededOrFailed()

- template: objectivec-unit-tests.yml
  parameters:
    jobName: "IosUnitTests"
    jobDependsOn:
      - Pre
      - IosBuild
    buildPlatform: iOS

# deactivated as long as ESRP signing doesn't support notarization
# - template: osx-test-app.yml
#   parameters:
#     continueOnTestFailure: ${{ parameters.continueOnTestFailure }}

- job: Doxygen
  dependsOn: Pre
  condition: and(succeeded('Pre'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' Doxygen '))
  pool:
    name: Hosted macOS
  timeoutInMinutes: 30
  variables:
    ArtifactOut: $(Build.ArtifactStagingDirectory)/Out
  steps:
  # Update bash really early so it will be picked up by "bash" steps.
  - bash: brew config && brew install bash
    displayName: Install modern bash
  - bash: sudo xcode-select -s /Applications/Xcode_10.3.app/Contents/Developer
    displayName: Select XCode Version 10.3
  - bash: ./ci/set-variables.sh
    displayName: Set variables
  - bash: |
      set -u -x -e -o pipefail
      ASTOUT="$(ArtifactOut)/objc/ast"
      MDOUT="$(ArtifactOut)/objc/md"
      mkdir -p "$ASTOUT" "$MDOUT"
      clang --version
      clang -fsyntax-only -x objective-c -Xclang -ast-dump source/bindings/objective-c/public/SPXSpeechApi.h \
        2>&1 1> "$ASTOUT/stdout.txt" | tee "$ASTOUT/stderr.txt"
      cd "$MDOUT"
      perl "$(Build.Repository.LocalPath)/ci/objc-docs-ast-to-md.pl" "$ASTOUT/stdout.txt"
    displayName: Create Objective-C reference docs
    continueOnError: true # TODO needs investigation - #1733600
  - bash: |
      set -e -o pipefail
      # log brew-related version information
      brew config
      brew install doxygen
      cd ci/doxygen
      mkdir -p "$(ArtifactOut)"
      rm -f doxygen.log || true
      touch doxygen.log
      # disabling the warning for 'documented empty return type' because of doxygen issue https://github.com/doxygen/doxygen/issues/7212
      for lang in c cpp csharp java; do
        (
          cat ${lang}_doxygen.txt
          echo PROJECT_NUMBER=$(SPEECHSDK_SEMVER2)
          echo 'WARN_FORMAT="##''vso[task.logissue type=warning;sourcepath=$file;linenumber=$line;columnnumber=1]$text"'
          echo OUTPUT_DIRECTORY="$(ArtifactOut)"
          echo QUIET=YES
          echo WARN_AS_ERROR=NO
        ) | doxygen - 2>&1 | ( grep -v -e 'Internal inconsistency: member .* does not belong to any container' -or -e 'warning: documented empty return type of .*' || true ) | tee -a doxygen.log
      done
      [[ -s doxygen.log ]] && {
        cat <<'HERE'
      Warnings occurred when running Doxygen. Please address them.

      Note:

      * We typically do not document protected members (Java, C++):
        Hide them at the source level by enclosing in the following Doxygen mark-up:

          /*! \cond PROTECTED */
          ...
          /*! \endcond */

      * Similarly, in C++, a nested class definition may show up as public even
        if the definition was done under a private qualifier. Hide these
        classes at the source level by enclosing in the following Doxygen
        mark-up:

          /*! \cond PRIVATE */
          ...
          /*! \endcond */

      * In Java, we also use the following mark-up for public things that really should be internal:

          /*! \cond INTERNAL */
          ...
          /*! \endcond */

      * For things you do not know how to resolve contact cfdev.
      HERE
        exit 1
      }
      git clone https://github.com/sourcey/moxygen.git
      cd moxygen
      git checkout c00d16803a6dfc40796cd4b76271c481ed865243
      git apply ../0001-Provide-shortname-provide-plain.patch
      npm install
      cd ..
      node moxygen/bin/moxygen.js -o cppapi.md -t ./moxygen_template/cpp -a "$(ArtifactOut)/cppxml"
      powershell -NoProfile -NoLogo -ExecutionPolicy Bypass -NonInteractive doxmox2docs.ps1 \
        -DoxygenIndexXml "$(ArtifactOut)/cppxml/index.xml" \
        -MoxygenApiMd cppapi.md \
        -OutputDir "$(ArtifactOut)/cppmd"
    displayName: Create documentation artifacts
  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: $(ArtifactOut)
      ArtifactName: Doxygen
      publishLocation: Container

- job: CheckSignatures
  dependsOn: [Pre, NuGet, AndroidPackage, JavaJrePackage, WindowsBuild, UnityBuild]
  condition: and(succeeded('Pre', 'NuGet', 'AndroidPackage', 'JavaJrePackage', 'WindowsBuild', 'UnityBuild'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' CheckSignatures '))
  pool:
    name: Hosted VS2017
  timeoutInMinutes: 60
  steps:
  - script: |
      echo ##vso[task.prependpath]C:\Program Files\Git\mingw64\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\usr\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\bin
    displayName: Work around for recent broken system path on Hosted VS2017 build agents.
    # see ICM https://icm.ad.msft.net/imp/v3/incidents/details/171621867/home
    # see PR  https://github.com/actions/virtual-environments/pull/211/files that broke many bash commands on Hosted VS2017 build agents.
  - task: NuGetToolInstaller@0
    displayName: 'NuGet Installer'
    inputs:
      versionSpec: 4.6.0
  - task: DownloadBuildArtifacts@0
    displayName: 'Download Build Artifacts Windows'
    inputs:
      artifactName: Windows
      itemPattern: |
        **/*.nupkg
        **/*.whl
  - task: DownloadBuildArtifacts@0
    displayName: 'Download Build Artifacts Android'
    inputs:
      artifactName: Android
      itemPattern: '**/*.aar'
  - task: DownloadBuildArtifacts@0
    displayName: 'Download Build JavaJrePackage'
    inputs:
      artifactName: JavaJrePackage
      itemPattern: '**/*.jar'
  - task: DownloadBuildArtifacts@0
    displayName: 'Download Build Unity'
    inputs:
      artifactName: Unity
      itemPattern: '**/*.unitypackage'
  - task: PowerShell@2
    displayName: 'Check Signatures'
    inputs:
      type: FilePath
      filePath: './ci/build/sigcheck.ps1'
      arguments: '-RootDirectory $(System.ArtifactsDirectory)'

- job: UnityBuild
  dependsOn: [Pre, AndroidBuild, WindowsBuild, WindowsUwpBuild, IosBuild]
  condition: and(succeeded('Pre', 'AndroidBuild', 'WindowsBuild', 'WindowsUwpBuild', 'IosBuild'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' UnityBuild '))
  pool:
    # The "Skyman Unity On-Prem" agent pool currently contains a single build
    # agent called "Skyman". It has three licensed Unity versions installed
    # on it, cf. the build agent's capabilities at
    # https://msasg.visualstudio.com/_settings/agentpools?_a=agents&poolId=620:
    #
    # Unity2018.3.7f1 - c:\Program Files\Unity2018.3.7f1
    # Unity2018.4.2f1 - c:\Program Files\Unity2018.4.2f1
    # Unity2019.1.7f1 - c:\Program Files\Unity2019.1.7f1
    #
    # Below we're using the last (newest) of these.
    #
    # The agent has been contributed and set up by Nick Horvath - many thanks!
    name: Skyman Unity On-Prem
    demands: VS2019 -equals true
  timeoutInMinutes: 30
  # Note: since the build agent isn't our "default" hosted agent, we have to
  # patch up how some things work. Also, be aware that it's persistent (not
  # restored to clean state after the build). So, be careful with things such
  # as secrets.
  # TODO we may need to extend wrt cancellation/process clean-up if we encounter any problems
  steps:
  - script: git clean -fdx
    displayName: Clean working directory
  - powershell: |
      Copy-Item -Recurse "$(Agent.HomeDirectory)\externals\git" copiedgit
      Copy-Item copiedgit\usr\bin\sh.exe copiedgit\usr\bin\bash.exe
      Write-Output "##vso[task.prependpath]$(Build.Repository.LocalPath)\copiedgit\usr\bin"
    displayName: Add VSTS Agent Git sh.exe as bash.exe to path
  # N.B. some things are still missing in the Bash setup, e.g., cygpath
  - script: where bash
    displayName: Validate that bash is in path
  - bash: ./ci/set-variables.sh
    displayName: Set variables
  - task: DownloadBuildArtifacts@0
    displayName: 'Downloading Windows artifacts'
    inputs:
      artifactName: Windows
      downloadPath: $(System.ArtifactsDirectory)\In
      itemPattern: '**/public/lib/**'
  - task: DownloadBuildArtifacts@0
    displayName: 'Downloading Android artifacts'
    inputs:
      artifactName: Android
      downloadPath: $(System.ArtifactsDirectory)\In
      itemPattern: '**/public/lib/**'
  - task: DownloadBuildArtifacts@0
    displayName: 'Downloading WindowsUwp artifacts'
    inputs:
      artifactName: WindowsUwp
      downloadPath: $(System.ArtifactsDirectory)\In
      itemPattern: '**/public/lib/**'
  - task: DownloadBuildArtifacts@0
    displayName: 'Downloading IOS artifacts'
    inputs:
      artifactName: IOS
      downloadPath: $(System.ArtifactsDirectory)\In
  - bash: ./ci/unity/build-unity.sh "$(Build.ArtifactStagingDirectory)/In"
    displayName: Build Unity Plugin content
  - bash: |
      . ci/functions.sh &&
      unity_batch \
        -projectPath ci/unity/unity \
        -exportPackage \
          Assets/SpeechSDK \
          Microsoft.CognitiveServices.Speech.$(SPEECHSDK_SEMVER2NOMETA).unitypackage
    displayName: Build Unity package
  - script: |
      mkdir "$(Build.ArtifactStagingDirectory)\Unity" && ^
      move ci\unity\unity\*.unitypackage "$(Build.ArtifactStagingDirectory)\Unity"
    displayName: Move Unity package into upload folder
  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/Unity'
      ArtifactName: Unity
      publishLocation: Container
    condition: succeededOrFailed()
    displayName: Publish Unity package

- job: DocFX
  dependsOn: Pre
  condition: and(succeeded('Pre'), contains(dependencies.Pre.outputs['var.SPEECHSDK_BUILD_PHASES'], ' DocFX '))
  pool:
    name: Hosted VS2017
  steps:
  - script: |
      echo ##vso[task.prependpath]C:\Program Files\Git\mingw64\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\usr\bin
      echo ##vso[task.prependpath]C:\Program Files\Git\bin
    displayName: Work around for recent broken system path on Hosted VS2017 build agents.
    # see ICM https://icm.ad.msft.net/imp/v3/incidents/details/171621867/home
    # see PR  https://github.com/actions/virtual-environments/pull/211/files that broke many bash commands on Hosted VS2017 build agents.
  - script: choco install docfx -y
    displayName: Install DocFX
  - script: docfx
    displayName: Run docfx
    workingDirectory: ci/docfx
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: docfx'
    inputs:
      PathtoPublish: 'build/docfx'
      ArtifactName: docfx
